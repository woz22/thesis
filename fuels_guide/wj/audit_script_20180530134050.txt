library( "DBI")
library( "RMySQL")
library( "GDD")
dbd <- dbDriver( "MySQL")
con <- dbConnect( dbd, user=XXXXXXXX, password=XXXXXXXX, dbname="sagestep", host="dc2-mysql-02.kattare.com")

base <- dbGetQuery( con, "(select subplot.id as subplot_id, rcode, scode, pcode, ptype, subplot.number as sp_number, subplot.treatment from subplot, (select plot.id as plot_id, rcode, scode, plot.code as pcode, plot.type as ptype from plot, (select site.id as site_id, rcode, site.code as scode from site, (select region.id as region_id, region.code as rcode from region where (( region.code='WJ' ))  order by region_id) as r where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=r.region_id order by site_id) as s where (( plot.type='CP' )) and plot.site_id=s.site_id order by plot_id) as p where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=p.plot_id order by subplot_id) ")
subplot <- list()
set <- list()
attr <- list()
out <- data.frame()

vf_v628 <- dbGetQuery( con, "select subplot.id as subplot_id, subplot.sage_condition_pse as sp_phase from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id")

attr <- c( attr, list( vf_v628))
rm( vf_v628)


vf_v629 <- dbGetQuery( con, "select subplot.id as subplot_id, plots.elevation_m as p_elevation from subplot, (select plot.id, plot.elevation_m from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot_id")

attr <- c( attr, list( vf_v629))
rm( vf_v629)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v630 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v630) == 0 ){

vf_v630 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v630 <- vf_v630[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v631 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v631) == 0 ){

vf_v631 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v631 <- vf_v631[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v630) + 1
vf_v630 <- cbind( vf_v630, t( apply( vf_v630, 1, calc_sb)))
e <- ncol( vf_v630)
names( vf_v630)[b:e] <- c( "bad_id", "shrub_bio_ttl_ARAR8", "shrub_1hr_ARAR8", "shrub_10hr_ARAR8")
bad_id <- c(0)
shrub_bio_ttl_ARAR8 <- c(0)
shrub_1hr_ARAR8 <- c(0)
shrub_10hr_ARAR8 <- c(0)
n <- nrow( vf_v631)
i <- 1
while( i <= n ){
spid <- vf_v631[i,1]
yr <- vf_v631[i,2]
sper <- vf_v631[i,3]
vf_v632 <- subset( vf_v630, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v632$bad_id), 0)
shrub_bio_ttl_ARAR8[i] <- round( sum( vf_v632$shrub_bio_ttl_ARAR8), 0)
shrub_1hr_ARAR8[i] <- round( sum( vf_v632$shrub_1hr_ARAR8), 0)
shrub_10hr_ARAR8[i] <- round( sum( vf_v632$shrub_10hr_ARAR8), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ARAR8[i] <- -shrub_bio_ttl_ARAR8[i]
  shrub_1hr_ARAR8[i] <- -shrub_1hr_ARAR8[i]
  shrub_10hr_ARAR8[i] <- -shrub_10hr_ARAR8[i]
}
i <- i + 1
}
vf_v631 <- cbind( vf_v631, shrub_bio_ttl_ARAR8)
rm( shrub_bio_ttl_ARAR8)
vf_v631 <- cbind( vf_v631, shrub_1hr_ARAR8)
rm( shrub_1hr_ARAR8)
vf_v631 <- cbind( vf_v631, shrub_10hr_ARAR8)
rm( shrub_10hr_ARAR8)
subplot <- c( subplot, list( vf_v631))
rm( vf_v631)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRV' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v633 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v633) == 0 ){

vf_v633 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v633 <- vf_v633[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v634 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v634) == 0 ){

vf_v634 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v634 <- vf_v634[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v633) + 1
vf_v633 <- cbind( vf_v633, t( apply( vf_v633, 1, calc_sb)))
e <- ncol( vf_v633)
names( vf_v633)[b:e] <- c( "bad_id", "shrub_bio_ttl_ARTRV", "shrub_1hr_ARTRV", "shrub_10hr_ARTRV")
bad_id <- c(0)
shrub_bio_ttl_ARTRV <- c(0)
shrub_1hr_ARTRV <- c(0)
shrub_10hr_ARTRV <- c(0)
n <- nrow( vf_v634)
i <- 1
while( i <= n ){
spid <- vf_v634[i,1]
yr <- vf_v634[i,2]
sper <- vf_v634[i,3]
vf_v635 <- subset( vf_v633, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v635$bad_id), 0)
shrub_bio_ttl_ARTRV[i] <- round( sum( vf_v635$shrub_bio_ttl_ARTRV), 0)
shrub_1hr_ARTRV[i] <- round( sum( vf_v635$shrub_1hr_ARTRV), 0)
shrub_10hr_ARTRV[i] <- round( sum( vf_v635$shrub_10hr_ARTRV), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ARTRV[i] <- -shrub_bio_ttl_ARTRV[i]
  shrub_1hr_ARTRV[i] <- -shrub_1hr_ARTRV[i]
  shrub_10hr_ARTRV[i] <- -shrub_10hr_ARTRV[i]
}
i <- i + 1
}
vf_v634 <- cbind( vf_v634, shrub_bio_ttl_ARTRV)
rm( shrub_bio_ttl_ARTRV)
vf_v634 <- cbind( vf_v634, shrub_1hr_ARTRV)
rm( shrub_1hr_ARTRV)
vf_v634 <- cbind( vf_v634, shrub_10hr_ARTRV)
rm( shrub_10hr_ARTRV)
subplot <- c( subplot, list( vf_v634))
rm( vf_v634)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CEVE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v636 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v636) == 0 ){

vf_v636 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v636 <- vf_v636[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v637 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v637) == 0 ){

vf_v637 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v637 <- vf_v637[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v636) + 1
vf_v636 <- cbind( vf_v636, t( apply( vf_v636, 1, calc_sb)))
e <- ncol( vf_v636)
names( vf_v636)[b:e] <- c( "bad_id", "shrub_bio_ttl_CEVE", "shrub_1hr_CEVE", "shrub_10hr_CEVE")
bad_id <- c(0)
shrub_bio_ttl_CEVE <- c(0)
shrub_1hr_CEVE <- c(0)
shrub_10hr_CEVE <- c(0)
n <- nrow( vf_v637)
i <- 1
while( i <= n ){
spid <- vf_v637[i,1]
yr <- vf_v637[i,2]
sper <- vf_v637[i,3]
vf_v638 <- subset( vf_v636, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v638$bad_id), 0)
shrub_bio_ttl_CEVE[i] <- round( sum( vf_v638$shrub_bio_ttl_CEVE), 0)
shrub_1hr_CEVE[i] <- round( sum( vf_v638$shrub_1hr_CEVE), 0)
shrub_10hr_CEVE[i] <- round( sum( vf_v638$shrub_10hr_CEVE), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_CEVE[i] <- -shrub_bio_ttl_CEVE[i]
  shrub_1hr_CEVE[i] <- -shrub_1hr_CEVE[i]
  shrub_10hr_CEVE[i] <- -shrub_10hr_CEVE[i]
}
i <- i + 1
}
vf_v637 <- cbind( vf_v637, shrub_bio_ttl_CEVE)
rm( shrub_bio_ttl_CEVE)
vf_v637 <- cbind( vf_v637, shrub_1hr_CEVE)
rm( shrub_1hr_CEVE)
vf_v637 <- cbind( vf_v637, shrub_10hr_CEVE)
rm( shrub_10hr_CEVE)
subplot <- c( subplot, list( vf_v637))
rm( vf_v637)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v639 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v639) == 0 ){

vf_v639 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v639 <- vf_v639[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v640 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v640) == 0 ){

vf_v640 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v640 <- vf_v640[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v639) + 1
vf_v639 <- cbind( vf_v639, t( apply( vf_v639, 1, calc_sb)))
e <- ncol( vf_v639)
names( vf_v639)[b:e] <- c( "bad_id", "shrub_bio_ttl_CHVI8", "shrub_1hr_CHVI8", "shrub_10hr_CHVI8")
bad_id <- c(0)
shrub_bio_ttl_CHVI8 <- c(0)
shrub_1hr_CHVI8 <- c(0)
shrub_10hr_CHVI8 <- c(0)
n <- nrow( vf_v640)
i <- 1
while( i <= n ){
spid <- vf_v640[i,1]
yr <- vf_v640[i,2]
sper <- vf_v640[i,3]
vf_v641 <- subset( vf_v639, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v641$bad_id), 0)
shrub_bio_ttl_CHVI8[i] <- round( sum( vf_v641$shrub_bio_ttl_CHVI8), 0)
shrub_1hr_CHVI8[i] <- round( sum( vf_v641$shrub_1hr_CHVI8), 0)
shrub_10hr_CHVI8[i] <- round( sum( vf_v641$shrub_10hr_CHVI8), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_CHVI8[i] <- -shrub_bio_ttl_CHVI8[i]
  shrub_1hr_CHVI8[i] <- -shrub_1hr_CHVI8[i]
  shrub_10hr_CHVI8[i] <- -shrub_10hr_CHVI8[i]
}
i <- i + 1
}
vf_v640 <- cbind( vf_v640, shrub_bio_ttl_CHVI8)
rm( shrub_bio_ttl_CHVI8)
vf_v640 <- cbind( vf_v640, shrub_1hr_CHVI8)
rm( shrub_1hr_CHVI8)
vf_v640 <- cbind( vf_v640, shrub_10hr_CHVI8)
rm( shrub_10hr_CHVI8)
subplot <- c( subplot, list( vf_v640))
rm( vf_v640)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v642 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v642) == 0 ){

vf_v642 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v642 <- vf_v642[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v643 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v643) == 0 ){

vf_v643 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v643 <- vf_v643[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v642) + 1
vf_v642 <- cbind( vf_v642, t( apply( vf_v642, 1, calc_sb)))
e <- ncol( vf_v642)
names( vf_v642)[b:e] <- c( "bad_id", "shrub_bio_ttl_ERNA10", "shrub_1hr_ERNA10", "shrub_10hr_ERNA10")
bad_id <- c(0)
shrub_bio_ttl_ERNA10 <- c(0)
shrub_1hr_ERNA10 <- c(0)
shrub_10hr_ERNA10 <- c(0)
n <- nrow( vf_v643)
i <- 1
while( i <= n ){
spid <- vf_v643[i,1]
yr <- vf_v643[i,2]
sper <- vf_v643[i,3]
vf_v644 <- subset( vf_v642, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v644$bad_id), 0)
shrub_bio_ttl_ERNA10[i] <- round( sum( vf_v644$shrub_bio_ttl_ERNA10), 0)
shrub_1hr_ERNA10[i] <- round( sum( vf_v644$shrub_1hr_ERNA10), 0)
shrub_10hr_ERNA10[i] <- round( sum( vf_v644$shrub_10hr_ERNA10), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ERNA10[i] <- -shrub_bio_ttl_ERNA10[i]
  shrub_1hr_ERNA10[i] <- -shrub_1hr_ERNA10[i]
  shrub_10hr_ERNA10[i] <- -shrub_10hr_ERNA10[i]
}
i <- i + 1
}
vf_v643 <- cbind( vf_v643, shrub_bio_ttl_ERNA10)
rm( shrub_bio_ttl_ERNA10)
vf_v643 <- cbind( vf_v643, shrub_1hr_ERNA10)
rm( shrub_1hr_ERNA10)
vf_v643 <- cbind( vf_v643, shrub_10hr_ERNA10)
rm( shrub_10hr_ERNA10)
subplot <- c( subplot, list( vf_v643))
rm( vf_v643)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v645 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v645) == 0 ){

vf_v645 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v645 <- vf_v645[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v646 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v646) == 0 ){

vf_v646 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v646 <- vf_v646[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v645) + 1
vf_v645 <- cbind( vf_v645, t( apply( vf_v645, 1, calc_sb)))
e <- ncol( vf_v645)
names( vf_v645)[b:e] <- c( "bad_id", "shrub_bio_ttl_PUTR2", "shrub_1hr_PUTR2", "shrub_10hr_PUTR2")
bad_id <- c(0)
shrub_bio_ttl_PUTR2 <- c(0)
shrub_1hr_PUTR2 <- c(0)
shrub_10hr_PUTR2 <- c(0)
n <- nrow( vf_v646)
i <- 1
while( i <= n ){
spid <- vf_v646[i,1]
yr <- vf_v646[i,2]
sper <- vf_v646[i,3]
vf_v647 <- subset( vf_v645, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v647$bad_id), 0)
shrub_bio_ttl_PUTR2[i] <- round( sum( vf_v647$shrub_bio_ttl_PUTR2), 0)
shrub_1hr_PUTR2[i] <- round( sum( vf_v647$shrub_1hr_PUTR2), 0)
shrub_10hr_PUTR2[i] <- round( sum( vf_v647$shrub_10hr_PUTR2), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_PUTR2[i] <- -shrub_bio_ttl_PUTR2[i]
  shrub_1hr_PUTR2[i] <- -shrub_1hr_PUTR2[i]
  shrub_10hr_PUTR2[i] <- -shrub_10hr_PUTR2[i]
}
i <- i + 1
}
vf_v646 <- cbind( vf_v646, shrub_bio_ttl_PUTR2)
rm( shrub_bio_ttl_PUTR2)
vf_v646 <- cbind( vf_v646, shrub_1hr_PUTR2)
rm( shrub_1hr_PUTR2)
vf_v646 <- cbind( vf_v646, shrub_10hr_PUTR2)
rm( shrub_10hr_PUTR2)
subplot <- c( subplot, list( vf_v646))
rm( vf_v646)


vf_v648 <- dbGetQuery( con, " (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSDF' )) and subplot_sample.subplot_id=subplots.id) order by subplot_id, year, speriod ")

res <- dbSendQuery( con, "select subplot_sample_id, round( 13.86 * sum( intercepts_10_cnt)), round( 110.28 * sum( intercepts_100_cnt)) from veg_st_intercepts where subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v649 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v649) > 0 ){

names( vf_v649)[2] <- 'dwd_fuel_10h'
names( vf_v649)[3] <- 'dwd_fuel_100h'

} else {

vf_v649 <- data.frame( dwd_fuel_10h=NA, dwd_fuel_100h=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 21.22 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='S' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v650 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v650) > 0 ){

names( vf_v650)[2] <- 'dwd_fuel_1000h_s'

} else {

vf_v650 <- data.frame( dwd_fuel_1000h_s=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 15.913 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='R' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v651 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v651) > 0 ){

names( vf_v651)[2] <- 'dwd_fuel_1000h_r'

} else {

vf_v651 <- data.frame( dwd_fuel_1000h_r=NA)
}

vf_v648 <- merge( vf_v648, vf_v649, all=TRUE)
vf_v648 <- merge( vf_v648, vf_v650, all=TRUE)
vf_v648 <- merge( vf_v648, vf_v651, all=TRUE)
replace_NA_w_0 <- function( row){
value <- row[1]
if( is.na( value) ) value <- 0
return( value)
}

vf_v648['dwd_fuel_1000h_r'] <- apply( vf_v648['dwd_fuel_1000h_r'], 1, replace_NA_w_0)
vf_v648['dwd_fuel_1000h_s'] <- apply( vf_v648['dwd_fuel_1000h_s'], 1, replace_NA_w_0)
if( nrow( vf_v648) > 0 ){
vf_v648 <- vf_v648[,!(colnames( vf_v648) %in% c( "subplot_sample_id"))]
}
subplot <- c( subplot, list( vf_v648))
rm( vf_v648)


calc_live_hfl <- function( row){
gd <- as.numeric( row[6])
rslt <- round( (2.667 *  gd)  )
return( rslt)
}

calc_dead_hfl <- function( row){
dd <- as.numeric( row[8])
rslt <- round(( 2.667  * dd)) 
return( rslt)
}

calc_litter_hfl <- function( row){
tlw <- as.numeric( row[9])
lw <- as.numeric( row[10])
ld <- as.numeric( row[11])
if( is.na( tlw) || (tlw == 0) ) tlw <- lw
rslt <- round( (2.667 * tlw * ld / lw) )
if( !is.na( lw) && (lw == 0) ) rslt <- 0
return( rslt)
}

calc_stand_hfl <- function( row){
sd <- as.numeric( row[12])
rslt <- round( (2.667 *  sd)  )
return( rslt)
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, herb_ttl_wet_g, herb_growth_wet_g, herb_growth_dry_g, herb_dead_wet_g, herb_dead_dry_g, litter_ttl_wet_g, litter_samp_wet_g, litter_samp_dry_g, herb_standing_dry_g from veg_biomass inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_biomass.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v652 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v652) == 0 ){

vf_v652 <- data.frame( subplot_id=NA, year=NA, speriod=NA, herb_ttl_wet_g=NA, herb_growth_wet_g=NA, herb_growth_dry_g=NA, herb_dead_wet_g=NA, herb_dead_dry_g=NA, litter_ttl_wet_g=NA, litter_samp_wet_g=NA, litter_samp_dry_g=NA, herb_standing_dry_g=NA)
vf_v652 <- vf_v652[-1,]
}

vf_v652 <- cbind( vf_v652, apply( vf_v652, 1, calc_live_hfl))
names( vf_v652)[ncol( vf_v652)] <- "herb_fuel_live_wd"
vf_v652 <- cbind( vf_v652, apply( vf_v652, 1, calc_dead_hfl))
names( vf_v652)[ncol( vf_v652)] <- "herb_fuel_dead_wd"
vf_v652 <- cbind( vf_v652, apply( vf_v652, 1, calc_litter_hfl))
names( vf_v652)[ncol( vf_v652)] <- "ispace_litter_load_wd"
vf_v652 <- cbind( vf_v652, apply( vf_v652, 1, calc_stand_hfl))
names( vf_v652)[ncol( vf_v652)] <- "herb_fuel_stand_wd"
vf_v652 <- vf_v652[c( 1, 2, 3, 13, 14, 15, 16)]
subplot <- c( subplot, list( vf_v652))
rm( vf_v652)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v653 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v653) == 0 ){

vf_v653 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v653 <- vf_v653[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v654 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v654) == 0 ){

vf_v654 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v654 <- vf_v654[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v653) + 1
vf_v653 <- cbind( vf_v653, t( apply( vf_v653, 1, calc_sb)))
e <- ncol( vf_v653)
names( vf_v653)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v654)
i <- 1
while( i <= n ){
spid <- vf_v654[i,1]
yr <- vf_v654[i,2]
sper <- vf_v654[i,3]
vf_v655 <- subset( vf_v653, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v655$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v655$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v655$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v655$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v654 <- cbind( vf_v654, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v654 <- cbind( vf_v654, shrub_1hr)
rm( shrub_1hr)
vf_v654 <- cbind( vf_v654, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v656 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v656) == 0 ){

vf_v656 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v656 <- vf_v656[-1,]
}

vf_v654 <- merge( vf_v654, vf_v656, all=TRUE)
rm( vf_v656)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v654 <- cbind( vf_v654, apply( vf_v654, 1, calc_sbd))
names( vf_v654)[ncol( vf_v654)] <- "shrub_bd_ARAR8"
vf_v654 <- vf_v654[, -4]
vf_v654 <- vf_v654[, -4]
vf_v654 <- vf_v654[, -4]
vf_v654 <- vf_v654[, -4]
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRV' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v657 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v657) == 0 ){

vf_v657 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v657 <- vf_v657[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v658 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v658) == 0 ){

vf_v658 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v658 <- vf_v658[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v657) + 1
vf_v657 <- cbind( vf_v657, t( apply( vf_v657, 1, calc_sb)))
e <- ncol( vf_v657)
names( vf_v657)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v658)
i <- 1
while( i <= n ){
spid <- vf_v658[i,1]
yr <- vf_v658[i,2]
sper <- vf_v658[i,3]
vf_v659 <- subset( vf_v657, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v659$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v659$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v659$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v659$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v658 <- cbind( vf_v658, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v658 <- cbind( vf_v658, shrub_1hr)
rm( shrub_1hr)
vf_v658 <- cbind( vf_v658, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRV' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v660 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v660) == 0 ){

vf_v660 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v660 <- vf_v660[-1,]
}

vf_v658 <- merge( vf_v658, vf_v660, all=TRUE)
rm( vf_v660)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v658 <- cbind( vf_v658, apply( vf_v658, 1, calc_sbd))
names( vf_v658)[ncol( vf_v658)] <- "shrub_bd_ARTRV"
vf_v658 <- vf_v658[, -4]
vf_v658 <- vf_v658[, -4]
vf_v658 <- vf_v658[, -4]
vf_v658 <- vf_v658[, -4]
vf_v654 <- merge( vf_v654, vf_v658, all=TRUE)
rm( vf_v658)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CEVE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v661 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v661) == 0 ){

vf_v661 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v661 <- vf_v661[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v662 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v662) == 0 ){

vf_v662 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v662 <- vf_v662[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v661) + 1
vf_v661 <- cbind( vf_v661, t( apply( vf_v661, 1, calc_sb)))
e <- ncol( vf_v661)
names( vf_v661)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v662)
i <- 1
while( i <= n ){
spid <- vf_v662[i,1]
yr <- vf_v662[i,2]
sper <- vf_v662[i,3]
vf_v663 <- subset( vf_v661, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v663$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v663$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v663$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v663$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v662 <- cbind( vf_v662, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v662 <- cbind( vf_v662, shrub_1hr)
rm( shrub_1hr)
vf_v662 <- cbind( vf_v662, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CEVE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v664 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v664) == 0 ){

vf_v664 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v664 <- vf_v664[-1,]
}

vf_v662 <- merge( vf_v662, vf_v664, all=TRUE)
rm( vf_v664)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v662 <- cbind( vf_v662, apply( vf_v662, 1, calc_sbd))
names( vf_v662)[ncol( vf_v662)] <- "shrub_bd_CEVE"
vf_v662 <- vf_v662[, -4]
vf_v662 <- vf_v662[, -4]
vf_v662 <- vf_v662[, -4]
vf_v662 <- vf_v662[, -4]
vf_v654 <- merge( vf_v654, vf_v662, all=TRUE)
rm( vf_v662)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v665 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v665) == 0 ){

vf_v665 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v665 <- vf_v665[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v666 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v666) == 0 ){

vf_v666 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v666 <- vf_v666[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v665) + 1
vf_v665 <- cbind( vf_v665, t( apply( vf_v665, 1, calc_sb)))
e <- ncol( vf_v665)
names( vf_v665)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v666)
i <- 1
while( i <= n ){
spid <- vf_v666[i,1]
yr <- vf_v666[i,2]
sper <- vf_v666[i,3]
vf_v667 <- subset( vf_v665, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v667$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v667$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v667$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v667$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v666 <- cbind( vf_v666, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v666 <- cbind( vf_v666, shrub_1hr)
rm( shrub_1hr)
vf_v666 <- cbind( vf_v666, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v668 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v668) == 0 ){

vf_v668 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v668 <- vf_v668[-1,]
}

vf_v666 <- merge( vf_v666, vf_v668, all=TRUE)
rm( vf_v668)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v666 <- cbind( vf_v666, apply( vf_v666, 1, calc_sbd))
names( vf_v666)[ncol( vf_v666)] <- "shrub_bd_CHVI8"
vf_v666 <- vf_v666[, -4]
vf_v666 <- vf_v666[, -4]
vf_v666 <- vf_v666[, -4]
vf_v666 <- vf_v666[, -4]
vf_v654 <- merge( vf_v654, vf_v666, all=TRUE)
rm( vf_v666)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v669 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v669) == 0 ){

vf_v669 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v669 <- vf_v669[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v670 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v670) == 0 ){

vf_v670 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v670 <- vf_v670[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v669) + 1
vf_v669 <- cbind( vf_v669, t( apply( vf_v669, 1, calc_sb)))
e <- ncol( vf_v669)
names( vf_v669)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v670)
i <- 1
while( i <= n ){
spid <- vf_v670[i,1]
yr <- vf_v670[i,2]
sper <- vf_v670[i,3]
vf_v671 <- subset( vf_v669, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v671$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v671$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v671$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v671$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v670 <- cbind( vf_v670, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v670 <- cbind( vf_v670, shrub_1hr)
rm( shrub_1hr)
vf_v670 <- cbind( vf_v670, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v672 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v672) == 0 ){

vf_v672 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v672 <- vf_v672[-1,]
}

vf_v670 <- merge( vf_v670, vf_v672, all=TRUE)
rm( vf_v672)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v670 <- cbind( vf_v670, apply( vf_v670, 1, calc_sbd))
names( vf_v670)[ncol( vf_v670)] <- "shrub_bd_ERNA10"
vf_v670 <- vf_v670[, -4]
vf_v670 <- vf_v670[, -4]
vf_v670 <- vf_v670[, -4]
vf_v670 <- vf_v670[, -4]
vf_v654 <- merge( vf_v654, vf_v670, all=TRUE)
rm( vf_v670)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v673 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v673) == 0 ){

vf_v673 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v673 <- vf_v673[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v674 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v674) == 0 ){

vf_v674 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v674 <- vf_v674[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v673) + 1
vf_v673 <- cbind( vf_v673, t( apply( vf_v673, 1, calc_sb)))
e <- ncol( vf_v673)
names( vf_v673)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v674)
i <- 1
while( i <= n ){
spid <- vf_v674[i,1]
yr <- vf_v674[i,2]
sper <- vf_v674[i,3]
vf_v675 <- subset( vf_v673, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v675$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v675$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v675$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v675$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v674 <- cbind( vf_v674, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v674 <- cbind( vf_v674, shrub_1hr)
rm( shrub_1hr)
vf_v674 <- cbind( vf_v674, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v676 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v676) == 0 ){

vf_v676 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v676 <- vf_v676[-1,]
}

vf_v674 <- merge( vf_v674, vf_v676, all=TRUE)
rm( vf_v676)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v674 <- cbind( vf_v674, apply( vf_v674, 1, calc_sbd))
names( vf_v674)[ncol( vf_v674)] <- "shrub_bd_PUTR2"
vf_v674 <- vf_v674[, -4]
vf_v674 <- vf_v674[, -4]
vf_v674 <- vf_v674[, -4]
vf_v674 <- vf_v674[, -4]
vf_v654 <- merge( vf_v654, vf_v674, all=TRUE)
rm( vf_v674)
vf_v654[is.na(vf_v654[,c(4)]),c(4)] <- 0
vf_v654[is.na(vf_v654[,c(5)]),c(5)] <- 0
vf_v654[is.na(vf_v654[,c(6)]),c(6)] <- 0
vf_v654[is.na(vf_v654[,c(7)]),c(7)] <- 0
vf_v654[is.na(vf_v654[,c(8)]),c(8)] <- 0
vf_v654[is.na(vf_v654[,c(9)]),c(9)] <- 0

calc_ttl <- function( row){
ttl <- 0.0
ttl <- ttl + as.numeric( row[4])
ttl <- ttl + as.numeric( row[5])
ttl <- ttl + as.numeric( row[6])
ttl <- ttl + as.numeric( row[7])
ttl <- ttl + as.numeric( row[8])
ttl <- ttl + as.numeric( row[9])
return( round( ttl, 4))
}

vf_v677 <- cbind( vf_v654[, c(1,2,3)], apply( vf_v654, 1, calc_ttl))
names( vf_v677)[4] <- 'shrub_bulk_dns'
subplot <- c( subplot, list( vf_v677))
rm( vf_v677)


subplot <- c( subplot, list( vf_v654))
rm( vf_v654)


calc_live_hfl <- function( row){
gd <- as.numeric( row[6])
rslt <- round( (5.000 *  gd)  )
return( rslt)
}

calc_dead_hfl <- function( row){
dd <- as.numeric( row[8])
rslt <- round(( 5.000  * dd)) 
return( rslt)
}

calc_litter_hfl <- function( row){
tlw <- as.numeric( row[9])
lw <- as.numeric( row[10])
ld <- as.numeric( row[11])
if( is.na( tlw) || (tlw == 0) ) tlw <- lw
rslt <- round( (5.000 * tlw * ld / lw) )
if( !is.na( lw) && (lw == 0) ) rslt <- 0
return( rslt)
}

calc_stand_hfl <- function( row){
sd <- as.numeric( row[12])
rslt <- round( (5.000 *  sd)  )
return( rslt)
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, herb_ttl_wet_g, herb_growth_wet_g, herb_growth_dry_g, herb_dead_wet_g, herb_dead_dry_g, litter_ttl_wet_g, litter_samp_wet_g, litter_samp_dry_g, herb_standing_dry_g from veg_biomass inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_biomass.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v680 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v680) == 0 ){

vf_v680 <- data.frame( subplot_id=NA, year=NA, speriod=NA, herb_ttl_wet_g=NA, herb_growth_wet_g=NA, herb_growth_dry_g=NA, herb_dead_wet_g=NA, herb_dead_dry_g=NA, litter_ttl_wet_g=NA, litter_samp_wet_g=NA, litter_samp_dry_g=NA, herb_standing_dry_g=NA)
vf_v680 <- vf_v680[-1,]
}

vf_v680 <- cbind( vf_v680, apply( vf_v680, 1, calc_live_hfl))
names( vf_v680)[ncol( vf_v680)] <- "herb_fuel_live_ss"
vf_v680 <- cbind( vf_v680, apply( vf_v680, 1, calc_dead_hfl))
names( vf_v680)[ncol( vf_v680)] <- "herb_fuel_dead_ss"
vf_v680 <- cbind( vf_v680, apply( vf_v680, 1, calc_litter_hfl))
names( vf_v680)[ncol( vf_v680)] <- "ispace_litter_load_ss"
vf_v680 <- cbind( vf_v680, apply( vf_v680, 1, calc_stand_hfl))
names( vf_v680)[ncol( vf_v680)] <- "herb_fuel_stand_ss"
vf_v680 <- vf_v680[c( 1, 2, 3, 13, 14, 15, 16)]
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( height_cm) / 16 as avg_grass_ht from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKGU#' or veg_height.species_txn='UKHU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v681 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v681) == 0 ){

vf_v681 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_grass_ht=NA)
vf_v681 <- vf_v681[-1,]
}

vf_v682 <- merge( vf_v680, vf_v681, all.x=TRUE, all.y=FALSE)
rm( vf_v680, vf_v681)

calc_hbd <- function( row){
hfl <- as.numeric( row[4]) + as.numeric( row[5])
aht <- as.numeric( row[7])
return( round( hfl/(100*aht), 4))
}

vf_v682 <- cbind( vf_v682, apply( vf_v682, 1, calc_hbd))
names( vf_v682)[ncol( vf_v682)] <- "herb_bulkdns_ss"
vf_v682 <- vf_v682[c( 1, 2, 3, 8)]
subplot <- c( subplot, list( vf_v682))
rm( vf_v682)


vf_v683 <- dbGetQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")

vf_v684 <- vf_v683
calc_td <- function( row){
hd <- as.numeric( row[4])
if( is.na( hd) ){ hd <- 0 }
hd_lt5 <- round( (10000/11.25) * hd)
sd <- as.numeric( row[5])
if( is.na( sd) ){ sd <- 0 }
sd_5_50 <- round( (10000/180) * sd)
th <- as.numeric( row[6])
if( is.na( th) ){ th <- 0 }
thb <- as.numeric( row[7])
if( is.na( thb) ){ thb <- 0 }
th_gt50 <- round( (th + thb)/0.099)
return( c( hd_lt5 + sd_5_50 + th_gt50, hd_lt5, sd_5_50, th_gt50))}
vf_v685 <- vf_v684
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='CELE3' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v686 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v686) == 0 ){

vf_v686 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v686 <- vf_v686[-1,]
}

vf_v685 <- merge( vf_v685, vf_v686, all=TRUE)
rm( vf_v686)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='CELE3' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v687 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v687) == 0 ){

vf_v687 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v687 <- vf_v687[-1,]
}

vf_v685 <- merge( vf_v685, vf_v687, all=TRUE)
rm( vf_v687)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='CELE3' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v688 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v688) == 0 ){

vf_v688 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v688 <- vf_v688[-1,]
}

vf_v685 <- merge( vf_v685, vf_v688, all=TRUE)
rm( vf_v688)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='CELE3' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v689 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v689) == 0 ){

vf_v689 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v689 <- vf_v689[-1,]
}

vf_v685 <- merge( vf_v685, vf_v689, all=TRUE)
rm( vf_v689)
vf_v685 <- apply( vf_v685, 1, calc_td)
vf_v685 <- t( vf_v685)
vf_v685 <- data.frame( vf_v685)
names( vf_v685)[1:4] <- c( "tree_dns_ttl_CELE3", "tree_dns_lt5_CELE3", "tree_dns_5_50_CELE3", "tree_dns_gt50_CELE3")
vf_v683 <- cbind( vf_v683, vf_v685)
vf_v690 <- vf_v684
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='JUOC' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v691 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v691) == 0 ){

vf_v691 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v691 <- vf_v691[-1,]
}

vf_v690 <- merge( vf_v690, vf_v691, all=TRUE)
rm( vf_v691)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='JUOC' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v692 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v692) == 0 ){

vf_v692 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v692 <- vf_v692[-1,]
}

vf_v690 <- merge( vf_v690, vf_v692, all=TRUE)
rm( vf_v692)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='JUOC' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v693 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v693) == 0 ){

vf_v693 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v693 <- vf_v693[-1,]
}

vf_v690 <- merge( vf_v690, vf_v693, all=TRUE)
rm( vf_v693)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='JUOC' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v694 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v694) == 0 ){

vf_v694 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v694 <- vf_v694[-1,]
}

vf_v690 <- merge( vf_v690, vf_v694, all=TRUE)
rm( vf_v694)
vf_v690 <- apply( vf_v690, 1, calc_td)
vf_v690 <- t( vf_v690)
vf_v690 <- data.frame( vf_v690)
names( vf_v690)[1:4] <- c( "tree_dns_ttl_JUOC", "tree_dns_lt5_JUOC", "tree_dns_5_50_JUOC", "tree_dns_gt50_JUOC")
vf_v683 <- cbind( vf_v683, vf_v690)
vf_v695 <- vf_v684
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='PIPO' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v696 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v696) == 0 ){

vf_v696 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v696 <- vf_v696[-1,]
}

vf_v695 <- merge( vf_v695, vf_v696, all=TRUE)
rm( vf_v696)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='PIPO' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v697 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v697) == 0 ){

vf_v697 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v697 <- vf_v697[-1,]
}

vf_v695 <- merge( vf_v695, vf_v697, all=TRUE)
rm( vf_v697)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='PIPO' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v698 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v698) == 0 ){

vf_v698 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v698 <- vf_v698[-1,]
}

vf_v695 <- merge( vf_v695, vf_v698, all=TRUE)
rm( vf_v698)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='PIPO' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v699 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v699) == 0 ){

vf_v699 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v699 <- vf_v699[-1,]
}

vf_v695 <- merge( vf_v695, vf_v699, all=TRUE)
rm( vf_v699)
vf_v695 <- apply( vf_v695, 1, calc_td)
vf_v695 <- t( vf_v695)
vf_v695 <- data.frame( vf_v695)
names( vf_v695)[1:4] <- c( "tree_dns_ttl_PIPO", "tree_dns_lt5_PIPO", "tree_dns_5_50_PIPO", "tree_dns_gt50_PIPO")
vf_v683 <- cbind( vf_v683, vf_v695)
subplot <- c( subplot, list( vf_v683))
rm( vf_v683)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSD') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v700 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v700) == 0 ){

vf_v700 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v700 <- vf_v700[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_AMAL2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='AMAL2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v701 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v701) == 0 ){

vf_v701 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_AMAL2=NA)
vf_v701 <- vf_v701[-1,]
}

vf_v700 <- merge( vf_v700, vf_v701, all=TRUE)
rm( vf_v701)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARAR8 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARAR8' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v702 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v702) == 0 ){

vf_v702 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARAR8=NA)
vf_v702 <- vf_v702[-1,]
}

vf_v700 <- merge( vf_v700, vf_v702, all=TRUE)
rm( vf_v702)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARRI2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARRI2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v703 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v703) == 0 ){

vf_v703 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARRI2=NA)
vf_v703 <- vf_v703[-1,]
}

vf_v700 <- merge( vf_v700, vf_v703, all=TRUE)
rm( vf_v703)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARTRT from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARTRT' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v704 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v704) == 0 ){

vf_v704 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARTRT=NA)
vf_v704 <- vf_v704[-1,]
}

vf_v700 <- merge( vf_v700, vf_v704, all=TRUE)
rm( vf_v704)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARTRV from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARTRV' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v705 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v705) == 0 ){

vf_v705 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARTRV=NA)
vf_v705 <- vf_v705[-1,]
}

vf_v700 <- merge( vf_v700, vf_v705, all=TRUE)
rm( vf_v705)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARTRW8 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARTRW8' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v706 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v706) == 0 ){

vf_v706 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARTRW8=NA)
vf_v706 <- vf_v706[-1,]
}

vf_v700 <- merge( vf_v700, vf_v706, all=TRUE)
rm( vf_v706)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_CEVE from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='CEVE' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v707 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v707) == 0 ){

vf_v707 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_CEVE=NA)
vf_v707 <- vf_v707[-1,]
}

vf_v700 <- merge( vf_v700, vf_v707, all=TRUE)
rm( vf_v707)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_CHVI8 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='CHVI8' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v708 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v708) == 0 ){

vf_v708 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_CHVI8=NA)
vf_v708 <- vf_v708[-1,]
}

vf_v700 <- merge( vf_v700, vf_v708, all=TRUE)
rm( vf_v708)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ERNA10 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ERNA10' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v709 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v709) == 0 ){

vf_v709 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ERNA10=NA)
vf_v709 <- vf_v709[-1,]
}

vf_v700 <- merge( vf_v700, vf_v709, all=TRUE)
rm( vf_v709)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ERSP7 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ERSP7' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v710 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v710) == 0 ){

vf_v710 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ERSP7=NA)
vf_v710 <- vf_v710[-1,]
}

vf_v700 <- merge( vf_v700, vf_v710, all=TRUE)
rm( vf_v710)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_PREM from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='PREM' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v711 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v711) == 0 ){

vf_v711 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_PREM=NA)
vf_v711 <- vf_v711[-1,]
}

vf_v700 <- merge( vf_v700, vf_v711, all=TRUE)
rm( vf_v711)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_PUTR2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='PUTR2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v712 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v712) == 0 ){

vf_v712 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_PUTR2=NA)
vf_v712 <- vf_v712[-1,]
}

vf_v700 <- merge( vf_v700, vf_v712, all=TRUE)
rm( vf_v712)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_RICE from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='RICE' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v713 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v713) == 0 ){

vf_v713 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_RICE=NA)
vf_v713 <- vf_v713[-1,]
}

vf_v700 <- merge( vf_v700, vf_v713, all=TRUE)
rm( vf_v713)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_RIVE from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='RIVE' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v714 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v714) == 0 ){

vf_v714 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_RIVE=NA)
vf_v714 <- vf_v714[-1,]
}

vf_v700 <- merge( vf_v700, vf_v714, all=TRUE)
rm( vf_v714)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_SANIC6 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='SANIC6' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v715 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v715) == 0 ){

vf_v715 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_SANIC6=NA)
vf_v715 <- vf_v715[-1,]
}

vf_v700 <- merge( vf_v700, vf_v715, all=TRUE)
rm( vf_v715)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_SYOR2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='SYOR2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v716 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v716) == 0 ){

vf_v716 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_SYOR2=NA)
vf_v716 <- vf_v716[-1,]
}

vf_v700 <- merge( vf_v700, vf_v716, all=TRUE)
rm( vf_v716)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_TECA2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='TECA2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v717 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v717) == 0 ){

vf_v717 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_TECA2=NA)
vf_v717 <- vf_v717[-1,]
}

vf_v700 <- merge( vf_v700, vf_v717, all=TRUE)
rm( vf_v717)
vf_v700[is.na(vf_v700[,c( ncol( vf_v700))]),c( ncol( vf_v700))] <- 0
subplot <- c( subplot, list( vf_v700))
rm( vf_v700)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v718 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v718) == 0 ){

vf_v718 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v718 <- vf_v718[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ARAR8 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v719 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v719) == 0 ){

vf_v719 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ARAR8=NA)
vf_v719 <- vf_v719[-1,]
}

vf_v718 <- merge( vf_v718, vf_v719, all=TRUE)
rm( vf_v719)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ARTRV from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ARTRV' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v720 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v720) == 0 ){

vf_v720 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ARTRV=NA)
vf_v720 <- vf_v720[-1,]
}

vf_v718 <- merge( vf_v718, vf_v720, all=TRUE)
rm( vf_v720)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_CEVE from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='CEVE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v721 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v721) == 0 ){

vf_v721 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_CEVE=NA)
vf_v721 <- vf_v721[-1,]
}

vf_v718 <- merge( vf_v718, vf_v721, all=TRUE)
rm( vf_v721)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_CHVI8 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v722 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v722) == 0 ){

vf_v722 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_CHVI8=NA)
vf_v722 <- vf_v722[-1,]
}

vf_v718 <- merge( vf_v718, vf_v722, all=TRUE)
rm( vf_v722)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ERNA10 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v723 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v723) == 0 ){

vf_v723 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ERNA10=NA)
vf_v723 <- vf_v723[-1,]
}

vf_v718 <- merge( vf_v718, vf_v723, all=TRUE)
rm( vf_v723)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_PUTR2 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v724 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v724) == 0 ){

vf_v724 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_PUTR2=NA)
vf_v724 <- vf_v724[-1,]
}

vf_v718 <- merge( vf_v718, vf_v724, all=TRUE)
rm( vf_v724)
vf_v718[is.na(vf_v718[,c( ncol( vf_v718))]),c( ncol( vf_v718))] <- 0
subplot <- c( subplot, list( vf_v718))
rm( vf_v718)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v725 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v725) == 0 ){

vf_v725 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v725 <- vf_v725[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as grass_ht_avg from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKGU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v726 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v726) == 0 ){

vf_v726 <- data.frame( subplot_id=NA, year=NA, speriod=NA, grass_ht_avg=NA)
vf_v726 <- vf_v726[-1,]
}

vf_v725 <- merge( vf_v725, vf_v726, all=TRUE)
rm( vf_v726)
vf_v725[is.na(vf_v725[,c( ncol( vf_v725))]),c( ncol( vf_v725))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as forb_ht_avg from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKHU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v727 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v727) == 0 ){

vf_v727 <- data.frame( subplot_id=NA, year=NA, speriod=NA, forb_ht_avg=NA)
vf_v727 <- vf_v727[-1,]
}

vf_v725 <- merge( vf_v725, vf_v727, all=TRUE)
rm( vf_v727)
vf_v725[is.na(vf_v725[,c( ncol( vf_v725))]),c( ncol( vf_v725))] <- 0
subplot <- c( subplot, list( vf_v725))
rm( vf_v725)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v728 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v728) == 0 ){

vf_v728 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v728 <- vf_v728[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, transect_tct as transect, point_tpt as tpoint from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod, transect, tpoint order by subplot_id, year, speriod, transect, tpoint")
vf_v729 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v729) == 0 ){

vf_v729 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA, subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA)
vf_v729 <- vf_v729[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, transect_tct as transect, point_tpt as tpoint, species_cnp as tc_sp, species_type as tc_t, species_nat as tc_n from veg_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_canopy.dead_yn='N' or veg_canopy.dead_yn is null ) and ( veg_canopy.canopy_type='A' )) and veg_canopy.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v730 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v730) == 0 ){

vf_v730 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA, tc_sp=NA, tc_t=NA, tc_n=NA)
vf_v730 <- vf_v730[-1,]
}

vf_v729 <- merge( vf_v729, vf_v730, all=TRUE)
rm( vf_v730)
res <- dbSendQuery( con, "select subplot_id, year, speriod, transect_tct as transect, point_tpt as tpoint, species_cnp as sc_sp, species_type as sc_t, species_nat as sc_n from veg_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_canopy.dead_yn='N' or veg_canopy.dead_yn is null ) and ( veg_canopy.canopy_type='B' )) and veg_canopy.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v731 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v731) == 0 ){

vf_v731 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA, sc_sp=NA, sc_t=NA, sc_n=NA)
vf_v731 <- vf_v731[-1,]
}

vf_v729 <- merge( vf_v729, vf_v731, all=TRUE)
rm( vf_v731)
res <- dbSendQuery( con, "select subplot_id, year, speriod, transect_tct as transect, point_tpt as tpoint, species_foc as f_sp, species_type as f_t, species_nat as f_n from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_foliar.code_enu='1' )) and veg_foliar.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v732 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v732) == 0 ){

vf_v732 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA, f_sp=NA, f_t=NA, f_n=NA)
vf_v732 <- vf_v732[-1,]
}

vf_v729 <- merge( vf_v729, vf_v732, all=TRUE)
rm( vf_v732)
res <- dbSendQuery( con, "select subplot_id, year, speriod, transect_tct as transect, point_tpt as tpoint, ground_surface_gsc as g_sp, species_type as g_t, species_nat as g_n from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v733 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v733) == 0 ){

vf_v733 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect=NA, tpoint=NA, g_sp=NA, g_t=NA, g_n=NA)
vf_v733 <- vf_v733[-1,]
}

vf_v729 <- merge( vf_v729, vf_v733, all=TRUE)
rm( vf_v733)

calc_hits <- function( row){
topCode <- NA
topType <- NA
topNat <- NA
topLayer <- 0
noHit <- c( row[1], row[2], row[3], 0)
hit <- c( row[1], row[2], row[3], 1)

if( !is.na( row['f_sp']) ){
  topCode <- row['f_sp']
  topType <- row['f_t']
  topNat <- row['f_n']
  topLayer <- 2
}else if( !is.na( row['g_sp']) ){
  topCode <- row['g_sp']
  topType <- row['g_t']
  topNat <- row['g_n']
  topLayer <- 1
}
if( is.na( topCode) ){
  return( noHit)
}
if( topLayer == 2 ){
  return( noHit)
}else if( topLayer == 1 ){
  if( !is.na( topCode) && ((topCode =='R') || (topCode =='BR') || (topCode =='S')) ){
    return( hit)
  }else{
    return( noHit)
  }
}
}

vf_v734 <- data.frame( subplot_id=NA, year=NA, speriod=NA, fc_bare_gnd_fol_cvr=NA)
n <- nrow( vf_v728)
i <- 1
while( i <= n ){
  spid <- vf_v728[i,1]
  yr <- vf_v728[i,2]
  sper <- vf_v728[i,3]
vf_v735 <- subset( vf_v729, (subplot_id==spid) & (year==yr) & (speriod==sper))
vf_v736 <- apply( vf_v735, 1, calc_hits)
  if( !is.null( nrow( vf_v736)) ){
vf_v734 <- rbind( vf_v734, c( spid, yr, sper, 100 * sum( as.numeric( vf_v736[4,]))))
  }
  i <- i + 1
}
vf_v734 <- vf_v734[-1,]
vf_v737 <- merge( vf_v728, vf_v734, all=TRUE)
rm( vf_v728, vf_v729, vf_v734, vf_v735, vf_v736)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v738 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v738) == 0 ){

vf_v738 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v738 <- vf_v738[-1,]
}

vf_v737 <- merge( vf_v737, vf_v738, all.x=TRUE, all.y=FALSE)
vf_v737[,4] <- round( as.numeric( vf_v737[,4]) / (60 * as.numeric( vf_v737[,5])), 1)
if( nrow( vf_v737) > 0 ){
vf_v737 <- vf_v737[,!(colnames( vf_v737) %in% c( "transect_count"))]
}
subplot <- c( subplot, list( vf_v737))
rm( vf_v737)


res <- dbSendQuery( con, "select subplot_id, year, speriod, species, count( species) as counts from (select subplot_id, year, speriod, species from ((select subplot_id, year, speriod, transect_tct, point_tpt, species_foc as species from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_foliar.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, species_cnp as species from veg_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_canopy.dead_yn='N' or veg_canopy.dead_yn is null )) and veg_canopy.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, ground_surface_gsc as species from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id )) as composite group by subplot_id, year, speriod, transect_tct, point_tpt, species) as tables_merged group by subplot_id, year, speriod, species order by subplot_id, year, speriod, species")
vf_v739 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v739) == 0 ){

vf_v739 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v739 <- vf_v739[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v740 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v740) == 0 ){

vf_v740 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v740 <- vf_v740[-1,]
}

vf_v739 <- merge( vf_v739, vf_v740, all.x=TRUE, all.y=FALSE)
calc_cover <- function( row){
sp_cnt <- as.numeric( row[5])
if( is.na( sp_cnt) ){ sp_cnt <- 0 }
trans_cnt <- as.numeric( row[6])
if( is.na( trans_cnt) || (trans_cnt == 0) ){ return( NA) }
return( as.numeric( sp_cnt) * 100/(60 * trans_cnt))
}

cover <- apply( vf_v739, 1, calc_cover)
cover <- round( cover, 1)
vf_v739 <- cbind( vf_v739, cover)
if( nrow( vf_v739) > 0 ){
vf_v739 <- vf_v739[,!(colnames( vf_v739) %in% c( "counts"))]
}
if( nrow( vf_v739) > 0 ){
vf_v739 <- vf_v739[,!(colnames( vf_v739) %in% c( "transect_count"))]
}
vf_v742 <- vf_v739[,1:3]
vf_v742 <- unique( vf_v742)
vf_v741 <- vf_v742
i <- 3
factors <- unique( sort( vf_v739$species))
for( f in factors ){
i <- i + 1
vf_v743 <- subset( vf_v739, species==f, c( subplot_id, year, speriod, cover))
vf_v743 <- merge( vf_v742, vf_v743, all=TRUE)
vf_v743[,4] <- ifelse( is.na( vf_v743[,4]), 0, vf_v743[,4])
vf_v743 <- vf_v743[,4]
vf_v741 <- cbind( vf_v741, vf_v743)
n <- f
names( vf_v741)[i] = paste( sep='', 'can_cover_', n)
rm( vf_v743)
}
subplot <- c( subplot, list( vf_v741))
rm( vf_v741)


vf_v744 <- dbGetQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")

vf_v745 <- vf_v744
calc_crn_cvr <- function( row){
dxd <- as.numeric( row[4])
if( is.na( dxd) ){ dxd <- 0 }
return( round( (pi/4) * dxd / 990, 1))}
tree_cover_ttl <- rep( 0, nrow( vf_v744))
vf_v744 <- cbind( vf_v744, tree_cover_ttl)
vf_v746 <- vf_v745
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='CELE3' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='CELE3' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v747 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v747) == 0 ){

vf_v747 <- c( 0)
}

vf_v746 <- merge( vf_v746, vf_v747, all=TRUE)
vf_v746 <- apply( vf_v746, 1, calc_crn_cvr)
vf_v746 <- data.frame( vf_v746)
names( vf_v746)[1] <- "tree_cvr_CELE3"
vf_v744 <- cbind( vf_v744, vf_v746)
vf_v748 <- vf_v745
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='JUOC' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='JUOC' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v749 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v749) == 0 ){

vf_v749 <- c( 0)
}

vf_v748 <- merge( vf_v748, vf_v749, all=TRUE)
vf_v748 <- apply( vf_v748, 1, calc_crn_cvr)
vf_v748 <- data.frame( vf_v748)
names( vf_v748)[1] <- "tree_cvr_JUOC"
vf_v744 <- cbind( vf_v744, vf_v748)
vf_v750 <- vf_v745
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='PIPO' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='PIPO' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v751 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v751) == 0 ){

vf_v751 <- c( 0)
}

vf_v750 <- merge( vf_v750, vf_v751, all=TRUE)
vf_v750 <- apply( vf_v750, 1, calc_crn_cvr)
vf_v750 <- data.frame( vf_v750)
names( vf_v750)[1] <- "tree_cvr_PIPO"
vf_v744 <- cbind( vf_v744, vf_v750)
vf_v744[4] <- vf_v744[4] + vf_v744[5]
vf_v744[4] <- vf_v744[4] + vf_v744[6]
vf_v744[4] <- vf_v744[4] + vf_v744[7]
subplot <- c( subplot, list( vf_v744))
rm( vf_v744)


res <- dbSendQuery( con, "select subplot_id, year, speriod, pl_type, count( pl_type) as counts from (select subplot_id, year, speriod, pl_type from ((select subplot_id, year, speriod, transect_tct, point_tpt, species_type as pl_type from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_foliar.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, species_type as pl_type from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id )) as composite group by subplot_id, year, speriod, transect_tct, point_tpt, pl_type) as tables_merged group by subplot_id, year, speriod, pl_type order by subplot_id, year, speriod, pl_type")
vf_v752 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v752) == 0 ){

vf_v752 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v752 <- vf_v752[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v753 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v753) == 0 ){

vf_v753 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v753 <- vf_v753[-1,]
}

vf_v752 <- merge( vf_v752, vf_v753, all.x=TRUE, all.y=FALSE)
calc_cover <- function( row){
sp_cnt <- as.numeric( row[5])
if( is.na( sp_cnt) ){ sp_cnt <- 0 }
trans_cnt <- as.numeric( row[6])
if( is.na( trans_cnt) || (trans_cnt == 0) ){ return( NA) }
return( as.numeric( sp_cnt) * 100/(60 * trans_cnt))
}

cover <- apply( vf_v752, 1, calc_cover)
cover <- round( cover, 1)
vf_v752 <- cbind( vf_v752, cover)
if( nrow( vf_v752) > 0 ){
vf_v752 <- vf_v752[,!(colnames( vf_v752) %in% c( "counts"))]
}
if( nrow( vf_v752) > 0 ){
vf_v752 <- vf_v752[,!(colnames( vf_v752) %in% c( "transect_count"))]
}
vf_v755 <- vf_v752[,1:3]
vf_v755 <- unique( vf_v755)
vf_v754 <- vf_v755
i <- 3
factors <- unique( sort( vf_v752$pl_type))
for( f in factors ){
i <- i + 1
vf_v756 <- subset( vf_v752, pl_type==f, c( subplot_id, year, speriod, cover))
vf_v756 <- merge( vf_v755, vf_v756, all=TRUE)
vf_v756[,4] <- ifelse( is.na( vf_v756[,4]), 0, vf_v756[,4])
vf_v756 <- vf_v756[,4]
vf_v754 <- cbind( vf_v754, vf_v756)
n <- f
if( f == 'A' ){ n <- 'tree' }
if( f == 'B' ){ n <- 'shrub' }
if( f == 'C' ){ n <- 'pgrass' }
if( f == 'D' ){ n <- 'pforb' }
if( f == 'E' ){ n <- 'agrass' }
if( f == 'F' ){ n <- 'aforb' }
if( f == 'G' ){ n <- 'grass' }
if( f == 'H' ){ n <- 'forb' }
names( vf_v754)[i] = paste( sep='', 'fol_cover_pt_', n)
rm( vf_v756)
}
subplot <- c( subplot, list( vf_v754))
rm( vf_v754)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v757 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v757) == 0 ){

vf_v757 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v757 <- vf_v757[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as counts from (select * from (select subplot_id, year, speriod, transect_tct, point_tpt from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_foliar.species_foc='L' or veg_foliar.species_foc='W' )) and veg_foliar.subplot_sample_id=sids.subplot_sample_id  union select subplot_id, year, speriod, transect_tct, point_tpt from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_surface.ground_surface_gsc='EL' or veg_surface.ground_surface_gsc='D' )) and veg_surface.subplot_sample_id=sids.subplot_sample_id ) as hits group by subplot_id, year, speriod, transect_tct, point_tpt order by subplot_id, year, speriod) as counts group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v758 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v758) == 0 ){

vf_v758 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v758 <- vf_v758[-1,]
}

vf_v758 <- merge( vf_v757, vf_v758, all=TRUE)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v759 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v759) == 0 ){

vf_v759 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v759 <- vf_v759[-1,]
}

vf_v758 <- merge( vf_v758, vf_v759, all.x=TRUE, all.y=FALSE)

get_sc <- function( row){
cnt <- row[4]
if( is.na( cnt) ) cnt <- 0
return( round( as.numeric( cnt) * 100/(60 * as.numeric( row[5])), 1))
}

vf_v758 <- cbind( vf_v758, apply( vf_v758, 1, get_sc))
names( vf_v758)[ncol( vf_v758)] <- "litter_cover"
if( nrow( vf_v758) > 0 ){
vf_v758 <- vf_v758[,!(colnames( vf_v758) %in% c( "counts"))]
}
if( nrow( vf_v758) > 0 ){
vf_v758 <- vf_v758[,!(colnames( vf_v758) %in% c( "transect_count"))]
}
subplot <- c( subplot, list( vf_v758))
rm( vf_v758)


res <- dbSendQuery( con, "select subplot_id, year, speriod, live_tree_dry_g, dead_tree_dry_g, live_tree_count, dead_tree_count from veg_ld_moisture_cs inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTL' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_ld_moisture_cs.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v760 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v760) == 0 ){

vf_v760 <- data.frame( subplot_id=NA, year=NA, speriod=NA, live_tree_dry_g=NA, dead_tree_dry_g=NA, live_tree_count=NA, dead_tree_count=NA)
vf_v760 <- vf_v760[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='WJ' ))  order by region.id) as regions  where (( site.code='WB' or site.code='BC' or site.code='DR' or site.code='BM' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.post_treatment_yn='N' or subplot_sample.post_treatment_yn='Y' ) and ( subplot_sample.sample_type_id='VSTH' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v761 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v761) == 0 ){

vf_v761 <- data.frame( subplot_id=NA, year=NA, speriod=NA, dxd=NA)
vf_v761 <- vf_v761[-1,]
}

vf_v762 <- merge( vf_v760, vf_v761, all.x=TRUE, all.y=FALSE)
rm( vf_v760, vf_v761)

calc_tcover <- function( row){
tcover <- (pi/4) * as.numeric( row[8]) / 99000
return( tcover)
}

vf_v762 <- cbind( vf_v762, apply( vf_v762, 1, calc_tcover))
names( vf_v762)[ncol( vf_v762)] <- "tcover"

calc_ltlitterduff <- function( row){
A <- as.numeric( row[9])
ltdg <- as.numeric( row[4])
n <- as.numeric( row[6])
return( round( (ltdg *  A * (160 / n)), 0))
}

vf_v762 <- cbind( vf_v762, apply( vf_v762, 1, calc_ltlitterduff))
names( vf_v762)[ncol( vf_v762)] <- "live_tree_ltr_duff_ld"

calc_dtlitterduff <- function( row){
A <- as.numeric( row[9])
dtdg <- as.numeric( row[5])
n <- as.numeric( row[7])
return( round( (dtdg *  A * (160 / n)), 0))
}

vf_v762 <- cbind( vf_v762, apply( vf_v762, 1, calc_dtlitterduff))
names( vf_v762)[ncol( vf_v762)] <- "dead_tree_ltr_duff_ld"

calc_ttltlitterduff <- function( row){
ltld <- as.numeric( row[10])
if( is.na( ltld)) ltld <- 0 
dtld <- as.numeric( row[11])
if( is.na( dtld)) dtld <- 0 
return( ltld + dtld)
}

vf_v762 <- cbind( vf_v762, apply( vf_v762, 1, calc_ttltlitterduff))
names( vf_v762)[ncol( vf_v762)] <- "tree_ltr_duff_ld"
vf_v762 <- vf_v762[c( 1, 2, 3, 10, 11, 12)]
subplot <- c( subplot, list( vf_v762))
rm( vf_v762)


if( length( set) > 0 ){
  for( df in set ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( set)
}
if( length( subplot) > 0 ){
  for( df in subplot ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( subplot)
}
if( nrow( out) > 0 ){
      out <- merge( out, base, all.x=TRUE, all.y=FALSE)
}
rm( base)

if( length( attr) > 0 ){
  for( df in attr ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( attr)
}
if( exists( "only") ){
      out <- only
}



write.csv( out, "/home3/s/sagestep/public_html/temp/data20180530134004.csv", row.names=FALSE,  na="NA")
q()
