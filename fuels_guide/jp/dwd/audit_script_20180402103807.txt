library( "DBI")
library( "RMySQL")
library( "GDD")
dbd <- dbDriver( "MySQL")
con <- dbConnect( dbd, user=XXXXXXXX, password=XXXXXXXX, dbname="sagestep", host="dc2-mysql-02.kattare.com")

base <- dbGetQuery( con, "(select subplot.id as subplot_id, rcode, scode, pcode, ptype, subplot.number as sp_number, subplot.treatment from subplot, (select plot.id as plot_id, rcode, scode, plot.code as pcode, plot.type as ptype from plot, (select site.id as site_id, rcode, site.code as scode from site, (select region.id as region_id, region.code as rcode from region where (( region.code='JP' ))  order by region_id) as r where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=r.region_id order by site_id) as s where (( plot.type='CP' )) and plot.site_id=s.site_id order by plot_id) as p where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=p.plot_id order by subplot_id) ")
subplot <- list()
set <- list()
attr <- list()
out <- data.frame()

vf_v926 <- dbGetQuery( con, "select subplot.id as subplot_id, subplot.sage_condition_pse as sp_phase from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id")

attr <- c( attr, list( vf_v926))
rm( vf_v926)


vf_v927 <- dbGetQuery( con, " (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSDF' )) and subplot_sample.subplot_id=subplots.id) order by subplot_id, year, speriod ")

res <- dbSendQuery( con, "select subplot_sample_id, round( 13.86 * sum( intercepts_10_cnt)), round( 110.28 * sum( intercepts_100_cnt)) from veg_st_intercepts where subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v928 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v928) > 0 ){

names( vf_v928)[2] <- 'dwd_fuel_10h'
names( vf_v928)[3] <- 'dwd_fuel_100h'

} else {

vf_v928 <- data.frame( dwd_fuel_10h=NA, dwd_fuel_100h=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 21.22 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='S' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v929 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v929) > 0 ){

names( vf_v929)[2] <- 'dwd_fuel_1000h_s'

} else {

vf_v929 <- data.frame( dwd_fuel_1000h_s=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 15.913 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='R' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v930 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v930) > 0 ){

names( vf_v930)[2] <- 'dwd_fuel_1000h_r'

} else {

vf_v930 <- data.frame( dwd_fuel_1000h_r=NA)
}

vf_v927 <- merge( vf_v927, vf_v928, all=TRUE)
vf_v927 <- merge( vf_v927, vf_v929, all=TRUE)
vf_v927 <- merge( vf_v927, vf_v930, all=TRUE)
replace_NA_w_0 <- function( row){
value <- row[1]
if( is.na( value) ) value <- 0
return( value)
}

vf_v927['dwd_fuel_1000h_r'] <- apply( vf_v927['dwd_fuel_1000h_r'], 1, replace_NA_w_0)
vf_v927['dwd_fuel_1000h_s'] <- apply( vf_v927['dwd_fuel_1000h_s'], 1, replace_NA_w_0)
if( nrow( vf_v927) > 0 ){
vf_v927 <- vf_v927[,!(colnames( vf_v927) %in% c( "subplot_sample_id"))]
}
subplot <- c( subplot, list( vf_v927))
rm( vf_v927)


res <- dbSendQuery( con, "select subplot_id, year, speriod, litter_wet_g, litter_dry_g, duff_wet_g, duff_dry_g from veg_ld_moisture inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTL' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_ld_moisture.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v931 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v931) == 0 ){

vf_v931 <- data.frame( subplot_id=NA, year=NA, speriod=NA, litter_wet_g=NA, litter_dry_g=NA, duff_wet_g=NA, duff_dry_g=NA)
vf_v931 <- vf_v931[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count( tree_num) as num_samples, sum( litter_wet_g) as sum_litter_wet_g, sum( duff_wet_g) as sum_duff_wet_g, sum( litter_depth_cm) as sum_litter_depth_cm, sum( duff_depth_cm) as sum_duff_depth_cm from veg_litter_duff inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTL' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_litter_duff.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v932 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v932) == 0 ){

vf_v932 <- data.frame( subplot_id=NA, year=NA, speriod=NA, num_samples=NA, sum_litter_wet_g=NA, sum_duff_wet_g=NA, sum_litter_depth_cm=NA, sum_duff_depth_cm=NA)
vf_v932 <- vf_v932[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.post_treatment_yn='N' ) and ( subplot_sample.sample_type_id='VSTH' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v933 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v933) == 0 ){

vf_v933 <- data.frame( subplot_id=NA, year=NA, speriod=NA, dxd=NA)
vf_v933 <- vf_v933[-1,]
}

if( nrow( vf_v933) > 0 ){
vf_v933 <- vf_v933[,!(colnames( vf_v933) %in% c( "year"))]
}
if( nrow( vf_v933) > 0 ){
vf_v933 <- vf_v933[,!(colnames( vf_v933) %in% c( "speriod"))]
}
vf_v934 <- merge( vf_v931, vf_v932, all=TRUE)
rm( vf_v931, vf_v932)
vf_v935 <- merge( vf_v934, vf_v933, all.x=TRUE, all.y=FALSE)
rm( vf_v934, vf_v933)

calc_tcover <- function( row){
tcover <- (pi/4) * as.numeric( row[13]) / 99000
return( tcover)
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tcover))
names( vf_v935)[ncol( vf_v935)] <- "tcover"

calc_tlitter <- function( row){
A <- as.numeric( row[14])
tl <- as.numeric( row[9])
lmsd <- as.numeric( row[5])
lmsw <- as.numeric( row[4])
n <- as.numeric( row[8])
return( round( (tl * (lmsd / lmsw) * A * (160 / n)), 0))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tlitter))
names( vf_v935)[ncol( vf_v935)] <- "tree_ltr_ld"

calc_tduff <- function( row){
A <- as.numeric( row[14])
td <- as.numeric( row[10])
dmsd <- as.numeric( row[7])
dmsw <- as.numeric( row[6])
n <- as.numeric( row[8])
return( round( (td * (dmsd / dmsw) * A * (160 / n)), 0))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tduff))
names( vf_v935)[ncol( vf_v935)] <- "tree_duff_ld"

calc_tltr_depth <- function( row){
tld <- as.numeric( row[11])
n <- as.numeric( row[8])
return( round( (tld / n), 1))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tltr_depth))
names( vf_v935)[ncol( vf_v935)] <- "tree_ltr_depth"

calc_duff_depth <- function( row){
tdd <- as.numeric( row[12])
n <- as.numeric( row[8])
return( round( (tdd / n), 1))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_duff_depth))
names( vf_v935)[ncol( vf_v935)] <- "tree_duff_depth"

calc_tltr_bulkd <- function( row){
tll <- as.numeric( row[15])
tld <- as.numeric( row[17])
return( round( (tll / (100 * tld)), 1))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tltr_bulkd))
names( vf_v935)[ncol( vf_v935)] <- "tree_ltr_bulkd"

calc_tduff_bulkd <- function( row){
tdl <- as.numeric( row[16])
tdd <- as.numeric( row[18])
return( round( (tdl / (100 * tdd)), 1))
}

vf_v935 <- cbind( vf_v935, apply( vf_v935, 1, calc_tduff_bulkd))
names( vf_v935)[ncol( vf_v935)] <- "tree_duff_bulkd"
vf_v935 <- vf_v935[c( 1, 2, 3, 15, 16, 17, 18, 19, 20)]
subplot <- c( subplot, list( vf_v935))
rm( vf_v935)


vf_v936 <- dbGetQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")

vf_v937 <- vf_v936
calc_crn_cvr <- function( row){
dxd <- as.numeric( row[4])
if( is.na( dxd) ){ dxd <- 0 }
return( round( (pi/4) * dxd / 990, 1))}
tree_cover_ttl <- rep( 0, nrow( vf_v936))
vf_v936 <- cbind( vf_v936, tree_cover_ttl)
vf_v938 <- vf_v937
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='JUOS' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='JUOS' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v939 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v939) == 0 ){

vf_v939 <- c( 0)
}

vf_v938 <- merge( vf_v938, vf_v939, all=TRUE)
vf_v938 <- apply( vf_v938, 1, calc_crn_cvr)
vf_v938 <- data.frame( vf_v938)
names( vf_v938)[1] <- "tree_cvr_JUOS"
vf_v936 <- cbind( vf_v936, vf_v938)
vf_v940 <- vf_v937
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='PIED' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='PIED' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v941 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v941) == 0 ){

vf_v941 <- c( 0)
}

vf_v940 <- merge( vf_v940, vf_v941, all=TRUE)
vf_v940 <- apply( vf_v940, 1, calc_crn_cvr)
vf_v940 <- data.frame( vf_v940)
names( vf_v940)[1] <- "tree_cvr_PIED"
vf_v936 <- cbind( vf_v936, vf_v940)
vf_v942 <- vf_v937
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='PIMO' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='PIMO' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v943 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v943) == 0 ){

vf_v943 <- c( 0)
}

vf_v942 <- merge( vf_v942, vf_v943, all=TRUE)
vf_v942 <- apply( vf_v942, 1, calc_crn_cvr)
vf_v942 <- data.frame( vf_v942)
names( vf_v942)[1] <- "tree_cvr_PIMO"
vf_v936 <- cbind( vf_v936, vf_v942)
vf_v936[4] <- vf_v936[4] + vf_v936[5]
vf_v936[4] <- vf_v936[4] + vf_v936[6]
vf_v936[4] <- vf_v936[4] + vf_v936[7]
subplot <- c( subplot, list( vf_v936))
rm( vf_v936)


res <- dbSendQuery( con, "select subplot_id, year, speriod, live_tree_dry_g, dead_tree_dry_g, live_tree_count, dead_tree_count from veg_ld_moisture_cs inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTL' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_ld_moisture_cs.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v944 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v944) == 0 ){

vf_v944 <- data.frame( subplot_id=NA, year=NA, speriod=NA, live_tree_dry_g=NA, dead_tree_dry_g=NA, live_tree_count=NA, dead_tree_count=NA)
vf_v944 <- vf_v944[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.post_treatment_yn='N' or subplot_sample.post_treatment_yn='Y' ) and ( subplot_sample.sample_type_id='VSTH' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v945 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v945) == 0 ){

vf_v945 <- data.frame( subplot_id=NA, year=NA, speriod=NA, dxd=NA)
vf_v945 <- vf_v945[-1,]
}

vf_v946 <- merge( vf_v944, vf_v945, all.x=TRUE, all.y=FALSE)
rm( vf_v944, vf_v945)

calc_tcover <- function( row){
tcover <- (pi/4) * as.numeric( row[8]) / 99000
return( tcover)
}

vf_v946 <- cbind( vf_v946, apply( vf_v946, 1, calc_tcover))
names( vf_v946)[ncol( vf_v946)] <- "tcover"

calc_ltlitterduff <- function( row){
A <- as.numeric( row[9])
ltdg <- as.numeric( row[4])
n <- as.numeric( row[6])
return( round( (ltdg *  A * (160 / n)), 0))
}

vf_v946 <- cbind( vf_v946, apply( vf_v946, 1, calc_ltlitterduff))
names( vf_v946)[ncol( vf_v946)] <- "live_tree_ltr_duff_ld"

calc_dtlitterduff <- function( row){
A <- as.numeric( row[9])
dtdg <- as.numeric( row[5])
n <- as.numeric( row[7])
return( round( (dtdg *  A * (160 / n)), 0))
}

vf_v946 <- cbind( vf_v946, apply( vf_v946, 1, calc_dtlitterduff))
names( vf_v946)[ncol( vf_v946)] <- "dead_tree_ltr_duff_ld"

calc_ttltlitterduff <- function( row){
ltld <- as.numeric( row[10])
if( is.na( ltld)) ltld <- 0 
dtld <- as.numeric( row[11])
if( is.na( dtld)) dtld <- 0 
return( ltld + dtld)
}

vf_v946 <- cbind( vf_v946, apply( vf_v946, 1, calc_ttltlitterduff))
names( vf_v946)[ncol( vf_v946)] <- "tree_ltr_duff_ld"
vf_v946 <- vf_v946[c( 1, 2, 3, 10, 11, 12)]
subplot <- c( subplot, list( vf_v946))
rm( vf_v946)


if( length( set) > 0 ){
  for( df in set ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( set)
}
if( length( subplot) > 0 ){
  for( df in subplot ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( subplot)
}
if( nrow( out) > 0 ){
      out <- merge( out, base, all.x=TRUE, all.y=FALSE)
}
rm( base)

if( length( attr) > 0 ){
  for( df in attr ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( attr)
}
if( exists( "only") ){
      out <- only
}



write.csv( out, "/home3/s/sagestep/public_html/temp/data20180402103801.csv", row.names=FALSE,  na="NA")
q()
