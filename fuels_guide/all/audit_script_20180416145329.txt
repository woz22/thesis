library( "DBI")
library( "RMySQL")
library( "GDD")
dbd <- dbDriver( "MySQL")
con <- dbConnect( dbd, user=XXXXXXXX, password=XXXXXXXX, dbname="sagestep", host="dc2-mysql-02.kattare.com")

base <- dbGetQuery( con, "(select subplot.id as subplot_id, rcode, scode, pcode, ptype, subplot.number as sp_number, subplot.treatment from subplot, (select plot.id as plot_id, rcode, scode, plot.code as pcode, plot.type as ptype from plot, (select site.id as site_id, rcode, site.code as scode from site, (select region.id as region_id, region.code as rcode from region where (( region.code='JP' ))  order by region_id) as r where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=r.region_id order by site_id) as s where (( plot.type='CP' )) and plot.site_id=s.site_id order by plot_id) as p where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=p.plot_id order by subplot_id) ")
subplot <- list()
set <- list()
attr <- list()
out <- data.frame()

vf_v983 <- dbGetQuery( con, "select subplot.id as subplot_id, subplot.sage_condition_pse as sp_phase from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id")

attr <- c( attr, list( vf_v983))
rm( vf_v983)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v984 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v984) == 0 ){

vf_v984 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v984 <- vf_v984[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v985 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v985) == 0 ){

vf_v985 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v985 <- vf_v985[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v984) + 1
vf_v984 <- cbind( vf_v984, t( apply( vf_v984, 1, calc_sb)))
e <- ncol( vf_v984)
names( vf_v984)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v985)
i <- 1
while( i <= n ){
spid <- vf_v985[i,1]
yr <- vf_v985[i,2]
sper <- vf_v985[i,3]
vf_v986 <- subset( vf_v984, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v986$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v986$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v986$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v986$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v985 <- cbind( vf_v985, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v985 <- cbind( vf_v985, shrub_1hr)
rm( shrub_1hr)
vf_v985 <- cbind( vf_v985, shrub_10hr)
rm( shrub_10hr)
subplot <- c( subplot, list( vf_v985))
rm( vf_v985)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v987 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v987) == 0 ){

vf_v987 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v987 <- vf_v987[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v988 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v988) == 0 ){

vf_v988 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v988 <- vf_v988[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v987) + 1
vf_v987 <- cbind( vf_v987, t( apply( vf_v987, 1, calc_sb)))
e <- ncol( vf_v987)
names( vf_v987)[b:e] <- c( "bad_id", "shrub_bio_ttl_ARAR8", "shrub_1hr_ARAR8", "shrub_10hr_ARAR8")
bad_id <- c(0)
shrub_bio_ttl_ARAR8 <- c(0)
shrub_1hr_ARAR8 <- c(0)
shrub_10hr_ARAR8 <- c(0)
n <- nrow( vf_v988)
i <- 1
while( i <= n ){
spid <- vf_v988[i,1]
yr <- vf_v988[i,2]
sper <- vf_v988[i,3]
vf_v989 <- subset( vf_v987, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v989$bad_id), 0)
shrub_bio_ttl_ARAR8[i] <- round( sum( vf_v989$shrub_bio_ttl_ARAR8), 0)
shrub_1hr_ARAR8[i] <- round( sum( vf_v989$shrub_1hr_ARAR8), 0)
shrub_10hr_ARAR8[i] <- round( sum( vf_v989$shrub_10hr_ARAR8), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ARAR8[i] <- -shrub_bio_ttl_ARAR8[i]
  shrub_1hr_ARAR8[i] <- -shrub_1hr_ARAR8[i]
  shrub_10hr_ARAR8[i] <- -shrub_10hr_ARAR8[i]
}
i <- i + 1
}
vf_v988 <- cbind( vf_v988, shrub_bio_ttl_ARAR8)
rm( shrub_bio_ttl_ARAR8)
vf_v988 <- cbind( vf_v988, shrub_1hr_ARAR8)
rm( shrub_1hr_ARAR8)
vf_v988 <- cbind( vf_v988, shrub_10hr_ARAR8)
rm( shrub_10hr_ARAR8)
subplot <- c( subplot, list( vf_v988))
rm( vf_v988)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARNO4' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v990 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v990) == 0 ){

vf_v990 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v990 <- vf_v990[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v991 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v991) == 0 ){

vf_v991 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v991 <- vf_v991[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v990) + 1
vf_v990 <- cbind( vf_v990, t( apply( vf_v990, 1, calc_sb)))
e <- ncol( vf_v990)
names( vf_v990)[b:e] <- c( "bad_id", "shrub_bio_ttl_ARNO4", "shrub_1hr_ARNO4", "shrub_10hr_ARNO4")
bad_id <- c(0)
shrub_bio_ttl_ARNO4 <- c(0)
shrub_1hr_ARNO4 <- c(0)
shrub_10hr_ARNO4 <- c(0)
n <- nrow( vf_v991)
i <- 1
while( i <= n ){
spid <- vf_v991[i,1]
yr <- vf_v991[i,2]
sper <- vf_v991[i,3]
vf_v992 <- subset( vf_v990, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v992$bad_id), 0)
shrub_bio_ttl_ARNO4[i] <- round( sum( vf_v992$shrub_bio_ttl_ARNO4), 0)
shrub_1hr_ARNO4[i] <- round( sum( vf_v992$shrub_1hr_ARNO4), 0)
shrub_10hr_ARNO4[i] <- round( sum( vf_v992$shrub_10hr_ARNO4), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ARNO4[i] <- -shrub_bio_ttl_ARNO4[i]
  shrub_1hr_ARNO4[i] <- -shrub_1hr_ARNO4[i]
  shrub_10hr_ARNO4[i] <- -shrub_10hr_ARNO4[i]
}
i <- i + 1
}
vf_v991 <- cbind( vf_v991, shrub_bio_ttl_ARNO4)
rm( shrub_bio_ttl_ARNO4)
vf_v991 <- cbind( vf_v991, shrub_1hr_ARNO4)
rm( shrub_1hr_ARNO4)
vf_v991 <- cbind( vf_v991, shrub_10hr_ARNO4)
rm( shrub_10hr_ARNO4)
subplot <- c( subplot, list( vf_v991))
rm( vf_v991)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRW8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v993 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v993) == 0 ){

vf_v993 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v993 <- vf_v993[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v994 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v994) == 0 ){

vf_v994 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v994 <- vf_v994[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v993) + 1
vf_v993 <- cbind( vf_v993, t( apply( vf_v993, 1, calc_sb)))
e <- ncol( vf_v993)
names( vf_v993)[b:e] <- c( "bad_id", "shrub_bio_ttl_ARTRW8", "shrub_1hr_ARTRW8", "shrub_10hr_ARTRW8")
bad_id <- c(0)
shrub_bio_ttl_ARTRW8 <- c(0)
shrub_1hr_ARTRW8 <- c(0)
shrub_10hr_ARTRW8 <- c(0)
n <- nrow( vf_v994)
i <- 1
while( i <= n ){
spid <- vf_v994[i,1]
yr <- vf_v994[i,2]
sper <- vf_v994[i,3]
vf_v995 <- subset( vf_v993, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v995$bad_id), 0)
shrub_bio_ttl_ARTRW8[i] <- round( sum( vf_v995$shrub_bio_ttl_ARTRW8), 0)
shrub_1hr_ARTRW8[i] <- round( sum( vf_v995$shrub_1hr_ARTRW8), 0)
shrub_10hr_ARTRW8[i] <- round( sum( vf_v995$shrub_10hr_ARTRW8), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ARTRW8[i] <- -shrub_bio_ttl_ARTRW8[i]
  shrub_1hr_ARTRW8[i] <- -shrub_1hr_ARTRW8[i]
  shrub_10hr_ARTRW8[i] <- -shrub_10hr_ARTRW8[i]
}
i <- i + 1
}
vf_v994 <- cbind( vf_v994, shrub_bio_ttl_ARTRW8)
rm( shrub_bio_ttl_ARTRW8)
vf_v994 <- cbind( vf_v994, shrub_1hr_ARTRW8)
rm( shrub_1hr_ARTRW8)
vf_v994 <- cbind( vf_v994, shrub_10hr_ARTRW8)
rm( shrub_10hr_ARTRW8)
subplot <- c( subplot, list( vf_v994))
rm( vf_v994)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ATCO' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v996 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v996) == 0 ){

vf_v996 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v996 <- vf_v996[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v997 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v997) == 0 ){

vf_v997 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v997 <- vf_v997[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v996) + 1
vf_v996 <- cbind( vf_v996, t( apply( vf_v996, 1, calc_sb)))
e <- ncol( vf_v996)
names( vf_v996)[b:e] <- c( "bad_id", "shrub_bio_ttl_ATCO", "shrub_1hr_ATCO", "shrub_10hr_ATCO")
bad_id <- c(0)
shrub_bio_ttl_ATCO <- c(0)
shrub_1hr_ATCO <- c(0)
shrub_10hr_ATCO <- c(0)
n <- nrow( vf_v997)
i <- 1
while( i <= n ){
spid <- vf_v997[i,1]
yr <- vf_v997[i,2]
sper <- vf_v997[i,3]
vf_v998 <- subset( vf_v996, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v998$bad_id), 0)
shrub_bio_ttl_ATCO[i] <- round( sum( vf_v998$shrub_bio_ttl_ATCO), 0)
shrub_1hr_ATCO[i] <- round( sum( vf_v998$shrub_1hr_ATCO), 0)
shrub_10hr_ATCO[i] <- round( sum( vf_v998$shrub_10hr_ATCO), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ATCO[i] <- -shrub_bio_ttl_ATCO[i]
  shrub_1hr_ATCO[i] <- -shrub_1hr_ATCO[i]
  shrub_10hr_ATCO[i] <- -shrub_10hr_ATCO[i]
}
i <- i + 1
}
vf_v997 <- cbind( vf_v997, shrub_bio_ttl_ATCO)
rm( shrub_bio_ttl_ATCO)
vf_v997 <- cbind( vf_v997, shrub_1hr_ATCO)
rm( shrub_1hr_ATCO)
vf_v997 <- cbind( vf_v997, shrub_10hr_ATCO)
rm( shrub_10hr_ATCO)
subplot <- c( subplot, list( vf_v997))
rm( vf_v997)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v999 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v999) == 0 ){

vf_v999 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v999 <- vf_v999[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v1 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v1) == 0 ){

vf_v1 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v1 <- vf_v1[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v999) + 1
vf_v999 <- cbind( vf_v999, t( apply( vf_v999, 1, calc_sb)))
e <- ncol( vf_v999)
names( vf_v999)[b:e] <- c( "bad_id", "shrub_bio_ttl_CHVI8", "shrub_1hr_CHVI8", "shrub_10hr_CHVI8")
bad_id <- c(0)
shrub_bio_ttl_CHVI8 <- c(0)
shrub_1hr_CHVI8 <- c(0)
shrub_10hr_CHVI8 <- c(0)
n <- nrow( vf_v1)
i <- 1
while( i <= n ){
spid <- vf_v1[i,1]
yr <- vf_v1[i,2]
sper <- vf_v1[i,3]
vf_v2 <- subset( vf_v999, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v2$bad_id), 0)
shrub_bio_ttl_CHVI8[i] <- round( sum( vf_v2$shrub_bio_ttl_CHVI8), 0)
shrub_1hr_CHVI8[i] <- round( sum( vf_v2$shrub_1hr_CHVI8), 0)
shrub_10hr_CHVI8[i] <- round( sum( vf_v2$shrub_10hr_CHVI8), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_CHVI8[i] <- -shrub_bio_ttl_CHVI8[i]
  shrub_1hr_CHVI8[i] <- -shrub_1hr_CHVI8[i]
  shrub_10hr_CHVI8[i] <- -shrub_10hr_CHVI8[i]
}
i <- i + 1
}
vf_v1 <- cbind( vf_v1, shrub_bio_ttl_CHVI8)
rm( shrub_bio_ttl_CHVI8)
vf_v1 <- cbind( vf_v1, shrub_1hr_CHVI8)
rm( shrub_1hr_CHVI8)
vf_v1 <- cbind( vf_v1, shrub_10hr_CHVI8)
rm( shrub_10hr_CHVI8)
subplot <- c( subplot, list( vf_v1))
rm( vf_v1)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPNE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v3 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v3) == 0 ){

vf_v3 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v3 <- vf_v3[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v4 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v4) == 0 ){

vf_v4 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v4 <- vf_v4[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v3) + 1
vf_v3 <- cbind( vf_v3, t( apply( vf_v3, 1, calc_sb)))
e <- ncol( vf_v3)
names( vf_v3)[b:e] <- c( "bad_id", "shrub_bio_ttl_EPNE", "shrub_1hr_EPNE", "shrub_10hr_EPNE")
bad_id <- c(0)
shrub_bio_ttl_EPNE <- c(0)
shrub_1hr_EPNE <- c(0)
shrub_10hr_EPNE <- c(0)
n <- nrow( vf_v4)
i <- 1
while( i <= n ){
spid <- vf_v4[i,1]
yr <- vf_v4[i,2]
sper <- vf_v4[i,3]
vf_v5 <- subset( vf_v3, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v5$bad_id), 0)
shrub_bio_ttl_EPNE[i] <- round( sum( vf_v5$shrub_bio_ttl_EPNE), 0)
shrub_1hr_EPNE[i] <- round( sum( vf_v5$shrub_1hr_EPNE), 0)
shrub_10hr_EPNE[i] <- round( sum( vf_v5$shrub_10hr_EPNE), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_EPNE[i] <- -shrub_bio_ttl_EPNE[i]
  shrub_1hr_EPNE[i] <- -shrub_1hr_EPNE[i]
  shrub_10hr_EPNE[i] <- -shrub_10hr_EPNE[i]
}
i <- i + 1
}
vf_v4 <- cbind( vf_v4, shrub_bio_ttl_EPNE)
rm( shrub_bio_ttl_EPNE)
vf_v4 <- cbind( vf_v4, shrub_1hr_EPNE)
rm( shrub_1hr_EPNE)
vf_v4 <- cbind( vf_v4, shrub_10hr_EPNE)
rm( shrub_10hr_EPNE)
subplot <- c( subplot, list( vf_v4))
rm( vf_v4)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPVI' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v6 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v6) == 0 ){

vf_v6 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v6 <- vf_v6[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v7 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v7) == 0 ){

vf_v7 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v7 <- vf_v7[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v6) + 1
vf_v6 <- cbind( vf_v6, t( apply( vf_v6, 1, calc_sb)))
e <- ncol( vf_v6)
names( vf_v6)[b:e] <- c( "bad_id", "shrub_bio_ttl_EPVI", "shrub_1hr_EPVI", "shrub_10hr_EPVI")
bad_id <- c(0)
shrub_bio_ttl_EPVI <- c(0)
shrub_1hr_EPVI <- c(0)
shrub_10hr_EPVI <- c(0)
n <- nrow( vf_v7)
i <- 1
while( i <= n ){
spid <- vf_v7[i,1]
yr <- vf_v7[i,2]
sper <- vf_v7[i,3]
vf_v8 <- subset( vf_v6, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v8$bad_id), 0)
shrub_bio_ttl_EPVI[i] <- round( sum( vf_v8$shrub_bio_ttl_EPVI), 0)
shrub_1hr_EPVI[i] <- round( sum( vf_v8$shrub_1hr_EPVI), 0)
shrub_10hr_EPVI[i] <- round( sum( vf_v8$shrub_10hr_EPVI), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_EPVI[i] <- -shrub_bio_ttl_EPVI[i]
  shrub_1hr_EPVI[i] <- -shrub_1hr_EPVI[i]
  shrub_10hr_EPVI[i] <- -shrub_10hr_EPVI[i]
}
i <- i + 1
}
vf_v7 <- cbind( vf_v7, shrub_bio_ttl_EPVI)
rm( shrub_bio_ttl_EPVI)
vf_v7 <- cbind( vf_v7, shrub_1hr_EPVI)
rm( shrub_1hr_EPVI)
vf_v7 <- cbind( vf_v7, shrub_10hr_EPVI)
rm( shrub_10hr_EPVI)
subplot <- c( subplot, list( vf_v7))
rm( vf_v7)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERCI6' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v9 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v9) == 0 ){

vf_v9 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v9 <- vf_v9[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v10 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v10) == 0 ){

vf_v10 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v10 <- vf_v10[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v9) + 1
vf_v9 <- cbind( vf_v9, t( apply( vf_v9, 1, calc_sb)))
e <- ncol( vf_v9)
names( vf_v9)[b:e] <- c( "bad_id", "shrub_bio_ttl_ERCI6", "shrub_1hr_ERCI6", "shrub_10hr_ERCI6")
bad_id <- c(0)
shrub_bio_ttl_ERCI6 <- c(0)
shrub_1hr_ERCI6 <- c(0)
shrub_10hr_ERCI6 <- c(0)
n <- nrow( vf_v10)
i <- 1
while( i <= n ){
spid <- vf_v10[i,1]
yr <- vf_v10[i,2]
sper <- vf_v10[i,3]
vf_v11 <- subset( vf_v9, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v11$bad_id), 0)
shrub_bio_ttl_ERCI6[i] <- round( sum( vf_v11$shrub_bio_ttl_ERCI6), 0)
shrub_1hr_ERCI6[i] <- round( sum( vf_v11$shrub_1hr_ERCI6), 0)
shrub_10hr_ERCI6[i] <- round( sum( vf_v11$shrub_10hr_ERCI6), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ERCI6[i] <- -shrub_bio_ttl_ERCI6[i]
  shrub_1hr_ERCI6[i] <- -shrub_1hr_ERCI6[i]
  shrub_10hr_ERCI6[i] <- -shrub_10hr_ERCI6[i]
}
i <- i + 1
}
vf_v10 <- cbind( vf_v10, shrub_bio_ttl_ERCI6)
rm( shrub_bio_ttl_ERCI6)
vf_v10 <- cbind( vf_v10, shrub_1hr_ERCI6)
rm( shrub_1hr_ERCI6)
vf_v10 <- cbind( vf_v10, shrub_10hr_ERCI6)
rm( shrub_10hr_ERCI6)
subplot <- c( subplot, list( vf_v10))
rm( vf_v10)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v12 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v12) == 0 ){

vf_v12 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v12 <- vf_v12[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v13 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v13) == 0 ){

vf_v13 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v13 <- vf_v13[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v12) + 1
vf_v12 <- cbind( vf_v12, t( apply( vf_v12, 1, calc_sb)))
e <- ncol( vf_v12)
names( vf_v12)[b:e] <- c( "bad_id", "shrub_bio_ttl_ERNA10", "shrub_1hr_ERNA10", "shrub_10hr_ERNA10")
bad_id <- c(0)
shrub_bio_ttl_ERNA10 <- c(0)
shrub_1hr_ERNA10 <- c(0)
shrub_10hr_ERNA10 <- c(0)
n <- nrow( vf_v13)
i <- 1
while( i <= n ){
spid <- vf_v13[i,1]
yr <- vf_v13[i,2]
sper <- vf_v13[i,3]
vf_v14 <- subset( vf_v12, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v14$bad_id), 0)
shrub_bio_ttl_ERNA10[i] <- round( sum( vf_v14$shrub_bio_ttl_ERNA10), 0)
shrub_1hr_ERNA10[i] <- round( sum( vf_v14$shrub_1hr_ERNA10), 0)
shrub_10hr_ERNA10[i] <- round( sum( vf_v14$shrub_10hr_ERNA10), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ERNA10[i] <- -shrub_bio_ttl_ERNA10[i]
  shrub_1hr_ERNA10[i] <- -shrub_1hr_ERNA10[i]
  shrub_10hr_ERNA10[i] <- -shrub_10hr_ERNA10[i]
}
i <- i + 1
}
vf_v13 <- cbind( vf_v13, shrub_bio_ttl_ERNA10)
rm( shrub_bio_ttl_ERNA10)
vf_v13 <- cbind( vf_v13, shrub_1hr_ERNA10)
rm( shrub_1hr_ERNA10)
vf_v13 <- cbind( vf_v13, shrub_10hr_ERNA10)
rm( shrub_10hr_ERNA10)
subplot <- c( subplot, list( vf_v13))
rm( vf_v13)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERSP7' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v15 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v15) == 0 ){

vf_v15 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v15 <- vf_v15[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v16 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v16) == 0 ){

vf_v16 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v16 <- vf_v16[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v15) + 1
vf_v15 <- cbind( vf_v15, t( apply( vf_v15, 1, calc_sb)))
e <- ncol( vf_v15)
names( vf_v15)[b:e] <- c( "bad_id", "shrub_bio_ttl_ERSP7", "shrub_1hr_ERSP7", "shrub_10hr_ERSP7")
bad_id <- c(0)
shrub_bio_ttl_ERSP7 <- c(0)
shrub_1hr_ERSP7 <- c(0)
shrub_10hr_ERSP7 <- c(0)
n <- nrow( vf_v16)
i <- 1
while( i <= n ){
spid <- vf_v16[i,1]
yr <- vf_v16[i,2]
sper <- vf_v16[i,3]
vf_v17 <- subset( vf_v15, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v17$bad_id), 0)
shrub_bio_ttl_ERSP7[i] <- round( sum( vf_v17$shrub_bio_ttl_ERSP7), 0)
shrub_1hr_ERSP7[i] <- round( sum( vf_v17$shrub_1hr_ERSP7), 0)
shrub_10hr_ERSP7[i] <- round( sum( vf_v17$shrub_10hr_ERSP7), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_ERSP7[i] <- -shrub_bio_ttl_ERSP7[i]
  shrub_1hr_ERSP7[i] <- -shrub_1hr_ERSP7[i]
  shrub_10hr_ERSP7[i] <- -shrub_10hr_ERSP7[i]
}
i <- i + 1
}
vf_v16 <- cbind( vf_v16, shrub_bio_ttl_ERSP7)
rm( shrub_bio_ttl_ERSP7)
vf_v16 <- cbind( vf_v16, shrub_1hr_ERSP7)
rm( shrub_1hr_ERSP7)
vf_v16 <- cbind( vf_v16, shrub_10hr_ERSP7)
rm( shrub_10hr_ERSP7)
subplot <- c( subplot, list( vf_v16))
rm( vf_v16)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GRSP' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v18 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v18) == 0 ){

vf_v18 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v18 <- vf_v18[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v19 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v19) == 0 ){

vf_v19 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v19 <- vf_v19[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v18) + 1
vf_v18 <- cbind( vf_v18, t( apply( vf_v18, 1, calc_sb)))
e <- ncol( vf_v18)
names( vf_v18)[b:e] <- c( "bad_id", "shrub_bio_ttl_GRSP", "shrub_1hr_GRSP", "shrub_10hr_GRSP")
bad_id <- c(0)
shrub_bio_ttl_GRSP <- c(0)
shrub_1hr_GRSP <- c(0)
shrub_10hr_GRSP <- c(0)
n <- nrow( vf_v19)
i <- 1
while( i <= n ){
spid <- vf_v19[i,1]
yr <- vf_v19[i,2]
sper <- vf_v19[i,3]
vf_v20 <- subset( vf_v18, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v20$bad_id), 0)
shrub_bio_ttl_GRSP[i] <- round( sum( vf_v20$shrub_bio_ttl_GRSP), 0)
shrub_1hr_GRSP[i] <- round( sum( vf_v20$shrub_1hr_GRSP), 0)
shrub_10hr_GRSP[i] <- round( sum( vf_v20$shrub_10hr_GRSP), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_GRSP[i] <- -shrub_bio_ttl_GRSP[i]
  shrub_1hr_GRSP[i] <- -shrub_1hr_GRSP[i]
  shrub_10hr_GRSP[i] <- -shrub_10hr_GRSP[i]
}
i <- i + 1
}
vf_v19 <- cbind( vf_v19, shrub_bio_ttl_GRSP)
rm( shrub_bio_ttl_GRSP)
vf_v19 <- cbind( vf_v19, shrub_1hr_GRSP)
rm( shrub_1hr_GRSP)
vf_v19 <- cbind( vf_v19, shrub_10hr_GRSP)
rm( shrub_10hr_GRSP)
subplot <- c( subplot, list( vf_v19))
rm( vf_v19)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GUSA2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v21 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v21) == 0 ){

vf_v21 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v21 <- vf_v21[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v22 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v22) == 0 ){

vf_v22 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v22 <- vf_v22[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v21) + 1
vf_v21 <- cbind( vf_v21, t( apply( vf_v21, 1, calc_sb)))
e <- ncol( vf_v21)
names( vf_v21)[b:e] <- c( "bad_id", "shrub_bio_ttl_GUSA2", "shrub_1hr_GUSA2", "shrub_10hr_GUSA2")
bad_id <- c(0)
shrub_bio_ttl_GUSA2 <- c(0)
shrub_1hr_GUSA2 <- c(0)
shrub_10hr_GUSA2 <- c(0)
n <- nrow( vf_v22)
i <- 1
while( i <= n ){
spid <- vf_v22[i,1]
yr <- vf_v22[i,2]
sper <- vf_v22[i,3]
vf_v23 <- subset( vf_v21, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v23$bad_id), 0)
shrub_bio_ttl_GUSA2[i] <- round( sum( vf_v23$shrub_bio_ttl_GUSA2), 0)
shrub_1hr_GUSA2[i] <- round( sum( vf_v23$shrub_1hr_GUSA2), 0)
shrub_10hr_GUSA2[i] <- round( sum( vf_v23$shrub_10hr_GUSA2), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_GUSA2[i] <- -shrub_bio_ttl_GUSA2[i]
  shrub_1hr_GUSA2[i] <- -shrub_1hr_GUSA2[i]
  shrub_10hr_GUSA2[i] <- -shrub_10hr_GUSA2[i]
}
i <- i + 1
}
vf_v22 <- cbind( vf_v22, shrub_bio_ttl_GUSA2)
rm( shrub_bio_ttl_GUSA2)
vf_v22 <- cbind( vf_v22, shrub_1hr_GUSA2)
rm( shrub_1hr_GUSA2)
vf_v22 <- cbind( vf_v22, shrub_10hr_GUSA2)
rm( shrub_10hr_GUSA2)
subplot <- c( subplot, list( vf_v22))
rm( vf_v22)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUST' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v24 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v24) == 0 ){

vf_v24 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v24 <- vf_v24[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v25 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v25) == 0 ){

vf_v25 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v25 <- vf_v25[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v24) + 1
vf_v24 <- cbind( vf_v24, t( apply( vf_v24, 1, calc_sb)))
e <- ncol( vf_v24)
names( vf_v24)[b:e] <- c( "bad_id", "shrub_bio_ttl_PUST", "shrub_1hr_PUST", "shrub_10hr_PUST")
bad_id <- c(0)
shrub_bio_ttl_PUST <- c(0)
shrub_1hr_PUST <- c(0)
shrub_10hr_PUST <- c(0)
n <- nrow( vf_v25)
i <- 1
while( i <= n ){
spid <- vf_v25[i,1]
yr <- vf_v25[i,2]
sper <- vf_v25[i,3]
vf_v26 <- subset( vf_v24, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v26$bad_id), 0)
shrub_bio_ttl_PUST[i] <- round( sum( vf_v26$shrub_bio_ttl_PUST), 0)
shrub_1hr_PUST[i] <- round( sum( vf_v26$shrub_1hr_PUST), 0)
shrub_10hr_PUST[i] <- round( sum( vf_v26$shrub_10hr_PUST), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_PUST[i] <- -shrub_bio_ttl_PUST[i]
  shrub_1hr_PUST[i] <- -shrub_1hr_PUST[i]
  shrub_10hr_PUST[i] <- -shrub_10hr_PUST[i]
}
i <- i + 1
}
vf_v25 <- cbind( vf_v25, shrub_bio_ttl_PUST)
rm( shrub_bio_ttl_PUST)
vf_v25 <- cbind( vf_v25, shrub_1hr_PUST)
rm( shrub_1hr_PUST)
vf_v25 <- cbind( vf_v25, shrub_10hr_PUST)
rm( shrub_10hr_PUST)
subplot <- c( subplot, list( vf_v25))
rm( vf_v25)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v27 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v27) == 0 ){

vf_v27 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v27 <- vf_v27[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v28 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v28) == 0 ){

vf_v28 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v28 <- vf_v28[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v27) + 1
vf_v27 <- cbind( vf_v27, t( apply( vf_v27, 1, calc_sb)))
e <- ncol( vf_v27)
names( vf_v27)[b:e] <- c( "bad_id", "shrub_bio_ttl_PUTR2", "shrub_1hr_PUTR2", "shrub_10hr_PUTR2")
bad_id <- c(0)
shrub_bio_ttl_PUTR2 <- c(0)
shrub_1hr_PUTR2 <- c(0)
shrub_10hr_PUTR2 <- c(0)
n <- nrow( vf_v28)
i <- 1
while( i <= n ){
spid <- vf_v28[i,1]
yr <- vf_v28[i,2]
sper <- vf_v28[i,3]
vf_v29 <- subset( vf_v27, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v29$bad_id), 0)
shrub_bio_ttl_PUTR2[i] <- round( sum( vf_v29$shrub_bio_ttl_PUTR2), 0)
shrub_1hr_PUTR2[i] <- round( sum( vf_v29$shrub_1hr_PUTR2), 0)
shrub_10hr_PUTR2[i] <- round( sum( vf_v29$shrub_10hr_PUTR2), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_PUTR2[i] <- -shrub_bio_ttl_PUTR2[i]
  shrub_1hr_PUTR2[i] <- -shrub_1hr_PUTR2[i]
  shrub_10hr_PUTR2[i] <- -shrub_10hr_PUTR2[i]
}
i <- i + 1
}
vf_v28 <- cbind( vf_v28, shrub_bio_ttl_PUTR2)
rm( shrub_bio_ttl_PUTR2)
vf_v28 <- cbind( vf_v28, shrub_1hr_PUTR2)
rm( shrub_1hr_PUTR2)
vf_v28 <- cbind( vf_v28, shrub_10hr_PUTR2)
rm( shrub_10hr_PUTR2)
subplot <- c( subplot, list( vf_v28))
rm( vf_v28)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='TEGL' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v30 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v30) == 0 ){

vf_v30 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v30 <- vf_v30[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v31 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v31) == 0 ){

vf_v31 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v31 <- vf_v31[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v30) + 1
vf_v30 <- cbind( vf_v30, t( apply( vf_v30, 1, calc_sb)))
e <- ncol( vf_v30)
names( vf_v30)[b:e] <- c( "bad_id", "shrub_bio_ttl_TEGL", "shrub_1hr_TEGL", "shrub_10hr_TEGL")
bad_id <- c(0)
shrub_bio_ttl_TEGL <- c(0)
shrub_1hr_TEGL <- c(0)
shrub_10hr_TEGL <- c(0)
n <- nrow( vf_v31)
i <- 1
while( i <= n ){
spid <- vf_v31[i,1]
yr <- vf_v31[i,2]
sper <- vf_v31[i,3]
vf_v32 <- subset( vf_v30, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v32$bad_id), 0)
shrub_bio_ttl_TEGL[i] <- round( sum( vf_v32$shrub_bio_ttl_TEGL), 0)
shrub_1hr_TEGL[i] <- round( sum( vf_v32$shrub_1hr_TEGL), 0)
shrub_10hr_TEGL[i] <- round( sum( vf_v32$shrub_10hr_TEGL), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl_TEGL[i] <- -shrub_bio_ttl_TEGL[i]
  shrub_1hr_TEGL[i] <- -shrub_1hr_TEGL[i]
  shrub_10hr_TEGL[i] <- -shrub_10hr_TEGL[i]
}
i <- i + 1
}
vf_v31 <- cbind( vf_v31, shrub_bio_ttl_TEGL)
rm( shrub_bio_ttl_TEGL)
vf_v31 <- cbind( vf_v31, shrub_1hr_TEGL)
rm( shrub_1hr_TEGL)
vf_v31 <- cbind( vf_v31, shrub_10hr_TEGL)
rm( shrub_10hr_TEGL)
subplot <- c( subplot, list( vf_v31))
rm( vf_v31)


vf_v33 <- dbGetQuery( con, " (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSDF' )) and subplot_sample.subplot_id=subplots.id) order by subplot_id, year, speriod ")

res <- dbSendQuery( con, "select subplot_sample_id, round( 13.86 * sum( intercepts_10_cnt)), round( 110.28 * sum( intercepts_100_cnt)) from veg_st_intercepts where subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v34 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v34) > 0 ){

names( vf_v34)[2] <- 'dwd_fuel_10h'
names( vf_v34)[3] <- 'dwd_fuel_100h'

} else {

vf_v34 <- data.frame( dwd_fuel_10h=NA, dwd_fuel_100h=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 21.22 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='S' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v35 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v35) > 0 ){

names( vf_v35)[2] <- 'dwd_fuel_1000h_s'

} else {

vf_v35 <- data.frame( dwd_fuel_1000h_s=NA)
}

res <- dbSendQuery( con, "select subplot_sample_id, round( 15.913 * sum( intercept_1000_cm * intercept_1000_cm/6.4516)) from veg_lt_intercept where decay_class_dec='R' and subplot_sample_id in (select subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSDF') and subplot_sample.subplot_id=subplots.id order by subplot_sample_id) group by subplot_sample_id")
vf_v36 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v36) > 0 ){

names( vf_v36)[2] <- 'dwd_fuel_1000h_r'

} else {

vf_v36 <- data.frame( dwd_fuel_1000h_r=NA)
}

vf_v33 <- merge( vf_v33, vf_v34, all=TRUE)
vf_v33 <- merge( vf_v33, vf_v35, all=TRUE)
vf_v33 <- merge( vf_v33, vf_v36, all=TRUE)
replace_NA_w_0 <- function( row){
value <- row[1]
if( is.na( value) ) value <- 0
return( value)
}

vf_v33['dwd_fuel_1000h_r'] <- apply( vf_v33['dwd_fuel_1000h_r'], 1, replace_NA_w_0)
vf_v33['dwd_fuel_1000h_s'] <- apply( vf_v33['dwd_fuel_1000h_s'], 1, replace_NA_w_0)
if( nrow( vf_v33) > 0 ){
vf_v33 <- vf_v33[,!(colnames( vf_v33) %in% c( "subplot_sample_id"))]
}
subplot <- c( subplot, list( vf_v33))
rm( vf_v33)


calc_live_hfl <- function( row){
gd <- as.numeric( row[6])
rslt <- round( (2.667 *  gd)  )
return( rslt)
}

calc_dead_hfl <- function( row){
dd <- as.numeric( row[8])
rslt <- round(( 2.667  * dd)) 
return( rslt)
}

calc_litter_hfl <- function( row){
tlw <- as.numeric( row[9])
lw <- as.numeric( row[10])
ld <- as.numeric( row[11])
if( is.na( tlw) || (tlw == 0) ) tlw <- lw
rslt <- round( (2.667 * tlw * ld / lw) )
if( !is.na( lw) && (lw == 0) ) rslt <- 0
return( rslt)
}

calc_stand_hfl <- function( row){
sd <- as.numeric( row[12])
rslt <- round( (2.667 *  sd)  )
return( rslt)
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, herb_ttl_wet_g, herb_growth_wet_g, herb_growth_dry_g, herb_dead_wet_g, herb_dead_dry_g, litter_ttl_wet_g, litter_samp_wet_g, litter_samp_dry_g, herb_standing_dry_g from veg_biomass inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_biomass.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v37 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v37) == 0 ){

vf_v37 <- data.frame( subplot_id=NA, year=NA, speriod=NA, herb_ttl_wet_g=NA, herb_growth_wet_g=NA, herb_growth_dry_g=NA, herb_dead_wet_g=NA, herb_dead_dry_g=NA, litter_ttl_wet_g=NA, litter_samp_wet_g=NA, litter_samp_dry_g=NA, herb_standing_dry_g=NA)
vf_v37 <- vf_v37[-1,]
}

vf_v37 <- cbind( vf_v37, apply( vf_v37, 1, calc_live_hfl))
names( vf_v37)[ncol( vf_v37)] <- "herb_fuel_live_wd"
vf_v37 <- cbind( vf_v37, apply( vf_v37, 1, calc_dead_hfl))
names( vf_v37)[ncol( vf_v37)] <- "herb_fuel_dead_wd"
vf_v37 <- cbind( vf_v37, apply( vf_v37, 1, calc_litter_hfl))
names( vf_v37)[ncol( vf_v37)] <- "ispace_litter_load_wd"
vf_v37 <- cbind( vf_v37, apply( vf_v37, 1, calc_stand_hfl))
names( vf_v37)[ncol( vf_v37)] <- "herb_fuel_stand_wd"
vf_v37 <- vf_v37[c( 1, 2, 3, 13, 14, 15, 16)]
subplot <- c( subplot, list( vf_v37))
rm( vf_v37)


res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v38 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v38) == 0 ){

vf_v38 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v38 <- vf_v38[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v39 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v39) == 0 ){

vf_v39 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v39 <- vf_v39[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v38) + 1
vf_v38 <- cbind( vf_v38, t( apply( vf_v38, 1, calc_sb)))
e <- ncol( vf_v38)
names( vf_v38)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v39)
i <- 1
while( i <= n ){
spid <- vf_v39[i,1]
yr <- vf_v39[i,2]
sper <- vf_v39[i,3]
vf_v40 <- subset( vf_v38, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v40$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v40$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v40$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v40$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v39 <- cbind( vf_v39, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v39 <- cbind( vf_v39, shrub_1hr)
rm( shrub_1hr)
vf_v39 <- cbind( vf_v39, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v41 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v41) == 0 ){

vf_v41 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v41 <- vf_v41[-1,]
}

vf_v39 <- merge( vf_v39, vf_v41, all=TRUE)
rm( vf_v41)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v39 <- cbind( vf_v39, apply( vf_v39, 1, calc_sbd))
names( vf_v39)[ncol( vf_v39)] <- "shrub_bd_ARAR8"
vf_v39 <- vf_v39[, -4]
vf_v39 <- vf_v39[, -4]
vf_v39 <- vf_v39[, -4]
vf_v39 <- vf_v39[, -4]
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARNO4' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v42 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v42) == 0 ){

vf_v42 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v42 <- vf_v42[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v43 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v43) == 0 ){

vf_v43 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v43 <- vf_v43[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v42) + 1
vf_v42 <- cbind( vf_v42, t( apply( vf_v42, 1, calc_sb)))
e <- ncol( vf_v42)
names( vf_v42)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v43)
i <- 1
while( i <= n ){
spid <- vf_v43[i,1]
yr <- vf_v43[i,2]
sper <- vf_v43[i,3]
vf_v44 <- subset( vf_v42, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v44$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v44$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v44$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v44$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v43 <- cbind( vf_v43, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v43 <- cbind( vf_v43, shrub_1hr)
rm( shrub_1hr)
vf_v43 <- cbind( vf_v43, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARNO4' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v45 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v45) == 0 ){

vf_v45 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v45 <- vf_v45[-1,]
}

vf_v43 <- merge( vf_v43, vf_v45, all=TRUE)
rm( vf_v45)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v43 <- cbind( vf_v43, apply( vf_v43, 1, calc_sbd))
names( vf_v43)[ncol( vf_v43)] <- "shrub_bd_ARNO4"
vf_v43 <- vf_v43[, -4]
vf_v43 <- vf_v43[, -4]
vf_v43 <- vf_v43[, -4]
vf_v43 <- vf_v43[, -4]
vf_v39 <- merge( vf_v39, vf_v43, all=TRUE)
rm( vf_v43)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRW8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v46 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v46) == 0 ){

vf_v46 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v46 <- vf_v46[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v47 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v47) == 0 ){

vf_v47 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v47 <- vf_v47[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v46) + 1
vf_v46 <- cbind( vf_v46, t( apply( vf_v46, 1, calc_sb)))
e <- ncol( vf_v46)
names( vf_v46)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v47)
i <- 1
while( i <= n ){
spid <- vf_v47[i,1]
yr <- vf_v47[i,2]
sper <- vf_v47[i,3]
vf_v48 <- subset( vf_v46, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v48$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v48$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v48$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v48$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v47 <- cbind( vf_v47, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v47 <- cbind( vf_v47, shrub_1hr)
rm( shrub_1hr)
vf_v47 <- cbind( vf_v47, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ARTRW8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v49 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v49) == 0 ){

vf_v49 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v49 <- vf_v49[-1,]
}

vf_v47 <- merge( vf_v47, vf_v49, all=TRUE)
rm( vf_v49)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v47 <- cbind( vf_v47, apply( vf_v47, 1, calc_sbd))
names( vf_v47)[ncol( vf_v47)] <- "shrub_bd_ARTRW8"
vf_v47 <- vf_v47[, -4]
vf_v47 <- vf_v47[, -4]
vf_v47 <- vf_v47[, -4]
vf_v47 <- vf_v47[, -4]
vf_v39 <- merge( vf_v39, vf_v47, all=TRUE)
rm( vf_v47)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ATCO' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v50 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v50) == 0 ){

vf_v50 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v50 <- vf_v50[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v51 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v51) == 0 ){

vf_v51 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v51 <- vf_v51[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v50) + 1
vf_v50 <- cbind( vf_v50, t( apply( vf_v50, 1, calc_sb)))
e <- ncol( vf_v50)
names( vf_v50)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v51)
i <- 1
while( i <= n ){
spid <- vf_v51[i,1]
yr <- vf_v51[i,2]
sper <- vf_v51[i,3]
vf_v52 <- subset( vf_v50, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v52$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v52$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v52$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v52$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v51 <- cbind( vf_v51, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v51 <- cbind( vf_v51, shrub_1hr)
rm( shrub_1hr)
vf_v51 <- cbind( vf_v51, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ATCO' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v53 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v53) == 0 ){

vf_v53 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v53 <- vf_v53[-1,]
}

vf_v51 <- merge( vf_v51, vf_v53, all=TRUE)
rm( vf_v53)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v51 <- cbind( vf_v51, apply( vf_v51, 1, calc_sbd))
names( vf_v51)[ncol( vf_v51)] <- "shrub_bd_ATCO"
vf_v51 <- vf_v51[, -4]
vf_v51 <- vf_v51[, -4]
vf_v51 <- vf_v51[, -4]
vf_v51 <- vf_v51[, -4]
vf_v39 <- merge( vf_v39, vf_v51, all=TRUE)
rm( vf_v51)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v54 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v54) == 0 ){

vf_v54 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v54 <- vf_v54[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v55 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v55) == 0 ){

vf_v55 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v55 <- vf_v55[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v54) + 1
vf_v54 <- cbind( vf_v54, t( apply( vf_v54, 1, calc_sb)))
e <- ncol( vf_v54)
names( vf_v54)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v55)
i <- 1
while( i <= n ){
spid <- vf_v55[i,1]
yr <- vf_v55[i,2]
sper <- vf_v55[i,3]
vf_v56 <- subset( vf_v54, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v56$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v56$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v56$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v56$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v55 <- cbind( vf_v55, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v55 <- cbind( vf_v55, shrub_1hr)
rm( shrub_1hr)
vf_v55 <- cbind( vf_v55, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v57 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v57) == 0 ){

vf_v57 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v57 <- vf_v57[-1,]
}

vf_v55 <- merge( vf_v55, vf_v57, all=TRUE)
rm( vf_v57)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v55 <- cbind( vf_v55, apply( vf_v55, 1, calc_sbd))
names( vf_v55)[ncol( vf_v55)] <- "shrub_bd_CHVI8"
vf_v55 <- vf_v55[, -4]
vf_v55 <- vf_v55[, -4]
vf_v55 <- vf_v55[, -4]
vf_v55 <- vf_v55[, -4]
vf_v39 <- merge( vf_v39, vf_v55, all=TRUE)
rm( vf_v55)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPNE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v58 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v58) == 0 ){

vf_v58 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v58 <- vf_v58[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v59 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v59) == 0 ){

vf_v59 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v59 <- vf_v59[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v58) + 1
vf_v58 <- cbind( vf_v58, t( apply( vf_v58, 1, calc_sb)))
e <- ncol( vf_v58)
names( vf_v58)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v59)
i <- 1
while( i <= n ){
spid <- vf_v59[i,1]
yr <- vf_v59[i,2]
sper <- vf_v59[i,3]
vf_v60 <- subset( vf_v58, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v60$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v60$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v60$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v60$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v59 <- cbind( vf_v59, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v59 <- cbind( vf_v59, shrub_1hr)
rm( shrub_1hr)
vf_v59 <- cbind( vf_v59, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPNE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v61 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v61) == 0 ){

vf_v61 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v61 <- vf_v61[-1,]
}

vf_v59 <- merge( vf_v59, vf_v61, all=TRUE)
rm( vf_v61)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v59 <- cbind( vf_v59, apply( vf_v59, 1, calc_sbd))
names( vf_v59)[ncol( vf_v59)] <- "shrub_bd_EPNE"
vf_v59 <- vf_v59[, -4]
vf_v59 <- vf_v59[, -4]
vf_v59 <- vf_v59[, -4]
vf_v59 <- vf_v59[, -4]
vf_v39 <- merge( vf_v39, vf_v59, all=TRUE)
rm( vf_v59)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPVI' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v62 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v62) == 0 ){

vf_v62 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v62 <- vf_v62[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v63 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v63) == 0 ){

vf_v63 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v63 <- vf_v63[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v62) + 1
vf_v62 <- cbind( vf_v62, t( apply( vf_v62, 1, calc_sb)))
e <- ncol( vf_v62)
names( vf_v62)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v63)
i <- 1
while( i <= n ){
spid <- vf_v63[i,1]
yr <- vf_v63[i,2]
sper <- vf_v63[i,3]
vf_v64 <- subset( vf_v62, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v64$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v64$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v64$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v64$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v63 <- cbind( vf_v63, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v63 <- cbind( vf_v63, shrub_1hr)
rm( shrub_1hr)
vf_v63 <- cbind( vf_v63, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='EPVI' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v65 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v65) == 0 ){

vf_v65 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v65 <- vf_v65[-1,]
}

vf_v63 <- merge( vf_v63, vf_v65, all=TRUE)
rm( vf_v65)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v63 <- cbind( vf_v63, apply( vf_v63, 1, calc_sbd))
names( vf_v63)[ncol( vf_v63)] <- "shrub_bd_EPVI"
vf_v63 <- vf_v63[, -4]
vf_v63 <- vf_v63[, -4]
vf_v63 <- vf_v63[, -4]
vf_v63 <- vf_v63[, -4]
vf_v39 <- merge( vf_v39, vf_v63, all=TRUE)
rm( vf_v63)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERCI6' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v66 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v66) == 0 ){

vf_v66 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v66 <- vf_v66[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v67 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v67) == 0 ){

vf_v67 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v67 <- vf_v67[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v66) + 1
vf_v66 <- cbind( vf_v66, t( apply( vf_v66, 1, calc_sb)))
e <- ncol( vf_v66)
names( vf_v66)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v67)
i <- 1
while( i <= n ){
spid <- vf_v67[i,1]
yr <- vf_v67[i,2]
sper <- vf_v67[i,3]
vf_v68 <- subset( vf_v66, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v68$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v68$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v68$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v68$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v67 <- cbind( vf_v67, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v67 <- cbind( vf_v67, shrub_1hr)
rm( shrub_1hr)
vf_v67 <- cbind( vf_v67, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERCI6' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v69 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v69) == 0 ){

vf_v69 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v69 <- vf_v69[-1,]
}

vf_v67 <- merge( vf_v67, vf_v69, all=TRUE)
rm( vf_v69)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v67 <- cbind( vf_v67, apply( vf_v67, 1, calc_sbd))
names( vf_v67)[ncol( vf_v67)] <- "shrub_bd_ERCI6"
vf_v67 <- vf_v67[, -4]
vf_v67 <- vf_v67[, -4]
vf_v67 <- vf_v67[, -4]
vf_v67 <- vf_v67[, -4]
vf_v39 <- merge( vf_v39, vf_v67, all=TRUE)
rm( vf_v67)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v70 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v70) == 0 ){

vf_v70 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v70 <- vf_v70[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v71 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v71) == 0 ){

vf_v71 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v71 <- vf_v71[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v70) + 1
vf_v70 <- cbind( vf_v70, t( apply( vf_v70, 1, calc_sb)))
e <- ncol( vf_v70)
names( vf_v70)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v71)
i <- 1
while( i <= n ){
spid <- vf_v71[i,1]
yr <- vf_v71[i,2]
sper <- vf_v71[i,3]
vf_v72 <- subset( vf_v70, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v72$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v72$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v72$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v72$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v71 <- cbind( vf_v71, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v71 <- cbind( vf_v71, shrub_1hr)
rm( shrub_1hr)
vf_v71 <- cbind( vf_v71, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v73 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v73) == 0 ){

vf_v73 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v73 <- vf_v73[-1,]
}

vf_v71 <- merge( vf_v71, vf_v73, all=TRUE)
rm( vf_v73)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v71 <- cbind( vf_v71, apply( vf_v71, 1, calc_sbd))
names( vf_v71)[ncol( vf_v71)] <- "shrub_bd_ERNA10"
vf_v71 <- vf_v71[, -4]
vf_v71 <- vf_v71[, -4]
vf_v71 <- vf_v71[, -4]
vf_v71 <- vf_v71[, -4]
vf_v39 <- merge( vf_v39, vf_v71, all=TRUE)
rm( vf_v71)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERSP7' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v74 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v74) == 0 ){

vf_v74 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v74 <- vf_v74[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v75 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v75) == 0 ){

vf_v75 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v75 <- vf_v75[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v74) + 1
vf_v74 <- cbind( vf_v74, t( apply( vf_v74, 1, calc_sb)))
e <- ncol( vf_v74)
names( vf_v74)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v75)
i <- 1
while( i <= n ){
spid <- vf_v75[i,1]
yr <- vf_v75[i,2]
sper <- vf_v75[i,3]
vf_v76 <- subset( vf_v74, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v76$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v76$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v76$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v76$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v75 <- cbind( vf_v75, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v75 <- cbind( vf_v75, shrub_1hr)
rm( shrub_1hr)
vf_v75 <- cbind( vf_v75, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='ERSP7' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v77 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v77) == 0 ){

vf_v77 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v77 <- vf_v77[-1,]
}

vf_v75 <- merge( vf_v75, vf_v77, all=TRUE)
rm( vf_v77)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v75 <- cbind( vf_v75, apply( vf_v75, 1, calc_sbd))
names( vf_v75)[ncol( vf_v75)] <- "shrub_bd_ERSP7"
vf_v75 <- vf_v75[, -4]
vf_v75 <- vf_v75[, -4]
vf_v75 <- vf_v75[, -4]
vf_v75 <- vf_v75[, -4]
vf_v39 <- merge( vf_v39, vf_v75, all=TRUE)
rm( vf_v75)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GRSP' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v78 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v78) == 0 ){

vf_v78 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v78 <- vf_v78[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v79 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v79) == 0 ){

vf_v79 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v79 <- vf_v79[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v78) + 1
vf_v78 <- cbind( vf_v78, t( apply( vf_v78, 1, calc_sb)))
e <- ncol( vf_v78)
names( vf_v78)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v79)
i <- 1
while( i <= n ){
spid <- vf_v79[i,1]
yr <- vf_v79[i,2]
sper <- vf_v79[i,3]
vf_v80 <- subset( vf_v78, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v80$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v80$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v80$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v80$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v79 <- cbind( vf_v79, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v79 <- cbind( vf_v79, shrub_1hr)
rm( shrub_1hr)
vf_v79 <- cbind( vf_v79, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GRSP' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v81 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v81) == 0 ){

vf_v81 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v81 <- vf_v81[-1,]
}

vf_v79 <- merge( vf_v79, vf_v81, all=TRUE)
rm( vf_v81)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v79 <- cbind( vf_v79, apply( vf_v79, 1, calc_sbd))
names( vf_v79)[ncol( vf_v79)] <- "shrub_bd_GRSP"
vf_v79 <- vf_v79[, -4]
vf_v79 <- vf_v79[, -4]
vf_v79 <- vf_v79[, -4]
vf_v79 <- vf_v79[, -4]
vf_v39 <- merge( vf_v39, vf_v79, all=TRUE)
rm( vf_v79)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GUSA2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v82 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v82) == 0 ){

vf_v82 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v82 <- vf_v82[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v83 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v83) == 0 ){

vf_v83 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v83 <- vf_v83[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v82) + 1
vf_v82 <- cbind( vf_v82, t( apply( vf_v82, 1, calc_sb)))
e <- ncol( vf_v82)
names( vf_v82)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v83)
i <- 1
while( i <= n ){
spid <- vf_v83[i,1]
yr <- vf_v83[i,2]
sper <- vf_v83[i,3]
vf_v84 <- subset( vf_v82, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v84$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v84$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v84$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v84$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v83 <- cbind( vf_v83, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v83 <- cbind( vf_v83, shrub_1hr)
rm( shrub_1hr)
vf_v83 <- cbind( vf_v83, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='GUSA2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v85 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v85) == 0 ){

vf_v85 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v85 <- vf_v85[-1,]
}

vf_v83 <- merge( vf_v83, vf_v85, all=TRUE)
rm( vf_v85)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v83 <- cbind( vf_v83, apply( vf_v83, 1, calc_sbd))
names( vf_v83)[ncol( vf_v83)] <- "shrub_bd_GUSA2"
vf_v83 <- vf_v83[, -4]
vf_v83 <- vf_v83[, -4]
vf_v83 <- vf_v83[, -4]
vf_v83 <- vf_v83[, -4]
vf_v39 <- merge( vf_v39, vf_v83, all=TRUE)
rm( vf_v83)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUST' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v86 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v86) == 0 ){

vf_v86 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v86 <- vf_v86[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v87 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v87) == 0 ){

vf_v87 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v87 <- vf_v87[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v86) + 1
vf_v86 <- cbind( vf_v86, t( apply( vf_v86, 1, calc_sb)))
e <- ncol( vf_v86)
names( vf_v86)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v87)
i <- 1
while( i <= n ){
spid <- vf_v87[i,1]
yr <- vf_v87[i,2]
sper <- vf_v87[i,3]
vf_v88 <- subset( vf_v86, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v88$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v88$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v88$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v88$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v87 <- cbind( vf_v87, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v87 <- cbind( vf_v87, shrub_1hr)
rm( shrub_1hr)
vf_v87 <- cbind( vf_v87, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUST' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v89 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v89) == 0 ){

vf_v89 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v89 <- vf_v89[-1,]
}

vf_v87 <- merge( vf_v87, vf_v89, all=TRUE)
rm( vf_v89)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v87 <- cbind( vf_v87, apply( vf_v87, 1, calc_sbd))
names( vf_v87)[ncol( vf_v87)] <- "shrub_bd_PUST"
vf_v87 <- vf_v87[, -4]
vf_v87 <- vf_v87[, -4]
vf_v87 <- vf_v87[, -4]
vf_v87 <- vf_v87[, -4]
vf_v39 <- merge( vf_v39, vf_v87, all=TRUE)
rm( vf_v87)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v90 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v90) == 0 ){

vf_v90 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v90 <- vf_v90[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v91 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v91) == 0 ){

vf_v91 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v91 <- vf_v91[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v90) + 1
vf_v90 <- cbind( vf_v90, t( apply( vf_v90, 1, calc_sb)))
e <- ncol( vf_v90)
names( vf_v90)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v91)
i <- 1
while( i <= n ){
spid <- vf_v91[i,1]
yr <- vf_v91[i,2]
sper <- vf_v91[i,3]
vf_v92 <- subset( vf_v90, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v92$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v92$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v92$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v92$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v91 <- cbind( vf_v91, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v91 <- cbind( vf_v91, shrub_1hr)
rm( shrub_1hr)
vf_v91 <- cbind( vf_v91, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v93 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v93) == 0 ){

vf_v93 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v93 <- vf_v93[-1,]
}

vf_v91 <- merge( vf_v91, vf_v93, all=TRUE)
rm( vf_v93)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v91 <- cbind( vf_v91, apply( vf_v91, 1, calc_sbd))
names( vf_v91)[ncol( vf_v91)] <- "shrub_bd_PUTR2"
vf_v91 <- vf_v91[, -4]
vf_v91 <- vf_v91[, -4]
vf_v91 <- vf_v91[, -4]
vf_v91 <- vf_v91[, -4]
vf_v39 <- merge( vf_v39, vf_v91, all=TRUE)
rm( vf_v91)
res <- dbSendQuery( con, "select subplot_id, year, speriod, concat( substring( veg_volume.subplot_sample_id, 1, 2), '.', substring( veg_volume.subplot_sample_id, 4, 2), '.', species_txn) as id, diameter_longest_cm as dia1, diameter_perp_cm as dia2, height_cm as hgt, ((pi()/6)*height_cm*diameter_longest_cm*diameter_perp_cm) as volume, (frame_diam*frame_diam*pi()*5/4) as area from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='TEGL' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v94 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v94) == 0 ){

vf_v94 <- data.frame( subplot_id=NA, year=NA, speriod=NA, id=NA, dia1=NA, dia2=NA, hgt=NA, volume=NA, area=NA)
vf_v94 <- vf_v94[-1,]
}

res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v95 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v95) == 0 ){

vf_v95 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v95 <- vf_v95[-1,]
}

p_ttl <- t( data.frame(
WJ.BM.ARTRV=c(0.066,0,0,0,0.00000247,'',''),
WJ.CH.ARTRV=c(0.143,0,0,0,0.00000102,'',''),
WJ.DR.ARTRV=c(0.0665,0,0,0,0.00000139,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.05924,0.00309,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.627,0,0.0186,0,0.0000006751,'',''),
WJ.CH.PUTR2=c(0.234,0,-0.00867,0,0.0000034,'',''),
WJ.CH.ARAR8=c(-0.0379,0.00454,-0.00313,0,0.00000229,'',''),
WJ.WB.CHVI8=c(-0.0939,0,0.000639,0,0,'',''),
WJ.BC.ARTRT=c(-0.404,0,0.00751,0.00475,0.00000128,'',''),
WJ.WB.ARTRV=c(0.00518,-0.00971,0,0.0114,0.00000484,'',''),
WJ.WB.ERNA10=c(-0.38,0.00721,0,0.0102,0,'',''),
SE.ON.ARTRW8=c(-0.46,0,0,0.0147,0.00000261,'',''),
SE.ON.ATCO=c(0.302,0,0,-0.00239,0.0000003082,'',''),
SE.OW.ARTRW8=c(-0.997,0.0463,0,-0.0238,0,'',''),
SE.RO.ARTRW8=c(0.0844,0,0,0,0.00000205,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.GB.ARTRW8=c(0.439,-0.0118,0,0,0.00000604,'',''),
SW.RC.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.GB.CHVI8=c(0.0342,0,0,0,0.00000176,'',''),
SW.SD.ARTRW8=c(0.0462,-0.00294,0.00422,0,0.00000112,'',''),
SW.SD.CHVI8=c(0.0304,-0.000974,0,0,0.00000144,'',''),
SW.MO.ARTRW8=c(-0.616,0,0,0.0174,0.000000861,'',''),
PJ.SP.ARNO4=c(-0.653,0.019,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.167,0.00501,0,0,0.00000393,'',''),
PJ.SP.CHVI8=c(-0.017,0.000894,0,0,0.00000263,'',''),
PJ.SP.PUTR2=c(-0.576,0,0,0.0158,0.00000188,'',''),
PJ.SR.ARTRW8=c(-0.0314,0,0,0,0.00000307,'',''),
PJ.SR.CHVI8=c(-0.00949,-0.00129,0.000958,0.00082,0.00000163,'',''),
PJ.SR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
PJ.SV.ARAR8=c(-0.266,0.00425,0.00716,0,0,'',''),
PJ.SV.ARNO4=c(-0.177,0.00679,0,0,0.00000522,'',''),
PJ.SV.ARTRW8=c(-0.1,0,-0.00989,0.0117,0.00000535,'',''),
PJ.SV.CHVI8=c(0.0049,0,0,0,0.00000216,'',''),
PJ.MC.ARTRW8=c(-0.401,0.0155,0,0,0.00000175,'',''),
PJ.MC.ARNO4=c(-0.037,0,0,0,0.00000661,'',''),
PJ.MC.CHVI8=c(-0.14,0.00247,0.00322,0,0,'',''),
PJ.MC.PUTR2=c(0.118,0,0,0,0.00000177,'',''),
JP.GR.ARTRW8=c(-0.22,-0.0112,0,0.0234,0.00000431,'',''),
JP.GR.CHVI8=c(-0.00841,0.00314,0,-0.00173,0,'',''),
JP.ON.ARTRW8=c(-0.439,0,0.0175,0,0.00000248,'',''),
JP.ON.ARNO4=c(0.0943,-0.00238,0,0,0.000000634,'',''),
JP.SC.ARTRW8=c(-0.099,0,0.000692,0,0.00000263,'',''),
JP.ST.ARTRV=c(0.505,0.0394,0,-0.0649,0.00000562,'',''),
JP.ST.PUTR2=c(0.527,0,0.0389,-0.0525,0.00000191,'',''),
CS.BR.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.BR.ARTRV=c(-.73059,0.02483,0,0,0,'',''),
CS.BR.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.BR.BAPR5=c(0,0,0,0,0,'',''),
CS.BR.CHVI8=c(0.07720,0,0,-0.00394,0.00000347,'',''),
CS.BR.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.BR.PUTR2=c(-0.94,0.0302,-0.0166,0,0.000000967,'',''),
CS.BR.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.CK.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.CK.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.CK.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.CK.BAPR5=c(0,0,0,0,0,'',''),
CS.CK.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.CK.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.CK.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.KE.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.KE.ARTRW8=c(-0.033,0,0,0,0.00000344,'',''),
CS.KE.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.KE.BAPR5=c(0,0,0,0,0,'',''),
CS.KE.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.KE.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.KE.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.RF.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.RF.ARTRV=c(-0.03484,0,0,0,0.00000445,'',''),
CS.RF.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.RF.BAPR5=c(0.01647,0,0,0,0.00000082256,'',''),
CS.RF.CHVI8=c(-0.03728,0,0,0,0.00000629,'',''),
CS.RF.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.RF.SAVE4=c(-0.85382,0.02203,0,0,0,'',''),
CS.TO.ARAR8=c(-0.01433,0,0,0,0.00000546,'',''),
CS.TO.ARTRV=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRT=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ARTRW8=c(-0.03467,0.01063,- 0.0121,0,0.00000367,'',''),
CS.TO.ATCO=c(0.06243,0,0,0,0.00000474,'',''),
CS.TO.BAPR5=c(0,0,0,0,0,'',''),
CS.TO.CHVI8=c(-0.1907,0,0.00828,0,0,'',''),
CS.TO.ERNA10=c(-0.52559,0,0.01504,0,0,'',''),
CS.TO.SAVE4=c(-0.85382,0.02203,0,0,0,'','')
))
p_1hr <- t( data.frame(
WJ.BM.ARTRV=c(0.105,0,0,0,0.00000106,'',''),
WJ.CH.ARTRV=c(-0.0415,0.00252,0,0,0.0000002176,'',''),
WJ.DR.ARTRV=c(0.033,0,0,0,0.0000005531,'',''),
WJ.BM.CHVI8=c(-0.0101,0,0.00148,0,0,'',''),
WJ.CH.CHVI8=c(-0.0439,0.00257,0,0,0,'',''),
WJ.BM.PUTR2=c(-0.347,0,0.0136,-0.00252,0.0000001414,'',''),
WJ.CH.PUTR2=c(0.0121,0,0,0,0.0000009385,'',''),
WJ.CH.ARAR8=c(0.0371,0,0,-0.00127,0.00000276,'',''),
WJ.WB.CHVI8=c(-0.0689,0.00351,0,0,0,'',''),
WJ.WB.ERNA10=c(-0.249,0.00625,0,0.00521,0,'',''),
WJ.BC.ARTRT=c(-0.104,0.00512,0,0,0.0000003118,'',''),
WJ.WB.ARTRV=c(-0.0502,0,0,0.00295,0.00000121,'',''),
SE.ON.ARTRW8=c(-0.114,0,0.00663,0,0.0000005413,'',''),
SE.ON.ATCO=c(0.186,0,0,-0.00135,0.000000174,'',''),
SE.OW.ARTRW8=c(0.0315,0,0,0,0.00000105,'',''),
SE.RO.ARTRW8=c(-0.07938,0,0,0.00522,0.000000425,'',''),
SE.RO.CHVI8=c(0.00103,0,0,0,0.00000737,'',''),
SW.RC.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.GB.ARTRW8=c(0.204,-0.00381,0,0,0.00000175,'',''),
SW.RC.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.GB.CHVI8=c(0.0364,0,0,0,0.00000143,'',''),
SW.SD.ARTRW8=c(0.0043,-0.00102,0.00233,0,0.0000003648,'',''),
SW.SD.CHVI8=c(0.0211,-0.00062,0,0,0.00000115,'',''),
SW.MO.ARTRW8=c(-0.188,0,0,0.00692,0,'',''),
PJ.SP.ARNO4=c(-0.131,0.00534,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.106,0.00938,0,-0.00666,0.0000005629,'',''),
PJ.SP.CHVI8=c(0.00831,0,0,0,0.00000264,'',''),
PJ.SP.PUTR2=c(-0.84,0.0139,0,0,0,'',''),
PJ.SR.ARTRW8=c(-0.108,0,0.00601,0,0,'',''),
PJ.SR.CHVI8=c(-0.00805,-0.00134,0.00109,0.000729,0.00000152,'',''),
PJ.SR.PUTR2=c(-0.457,0.00893,0,0,0.000000159,'',''),
PJ.SV.ARAR8=c(-0.11,0.00287,0.00226,0,0,'',''),
PJ.SV.ARNO4=c(-0.0308,0.00169,0,0,0.00000175,'',''),
PJ.SV.ARTRW8=c(-0.0135,0.00325,0,-0.00161,0.000001,'',''),
PJ.SV.CHVI8=c(0.00284,0,0.000855,-0.000654,0.00000157,'',''),
PJ.MC.ARTRW8=c(-0.156,0.00636,0,0,0,'',''),
PJ.MC.ARNO4=c(-0.0731,0.00767,-0.00448,0,0,'',''),
PJ.MC.CHVI8=c(-0.0985,0.00174,0.00257,0,0,'',''),
PJ.MC.PUTR2=c(0.0527,0,0,0,0.0000005956,'',''),
JP.GR.ARTRW8=c(-0.229,-0.00589,0.018,0,0,'',''),
JP.GR.CHVI8=c(-0.05,0.00202,0.00175,-0.00101,0,'',''),
JP.ON.ARTRW8=c(-0.25,0,0,0.012,0,'',''),
JP.ON.ARNO4=c(-0.134,0,0.00406,0.00296,0,'',''),
JP.SC.ARTRW8=c(-0.0111,0.00213,0,0,0.0000006542,'',''),
JP.ST.ARTRV=c(0.196,0.00638,0,-0.00984,0.00000113,'',''),
JP.ST.PUTR2=c(-0.247,0,0.0117,-0.00499,0.0000003409,'','')
))
p_10hr <- t( data.frame(
WJ.BM.ARTRV=c(0.058,0,0,0,0.0000008688,'',''),
WJ.CH.ARTRV=c(-0.0754,0.00754,-0.00605,0,0.0000004198,'',''),
WJ.DR.ARTRV=c(0.0253,0,0,0,0.0000006137,'',''),
WJ.BM.PUTR2=c(0.0702,-0.0018,0,0,0.00000131,'',''),
WJ.CH.PUTR2=c(0.0745,-0.0018,0,0,0.00000131,'',''),
WJ.CH.ARAR8=c(-0.0441,0.00465,-0.00329,0,0,'',''),
WJ.WB.CHVI8=c(-0.085,0,0.00412,0,-0.0000005533,'',''),
WJ.WB.ERNA10=c(-0.024,0.00304,0,0,0,'',''),
WJ.BC.ARTRT=c(-0.224,0.00484,0,0,0.0000005582,'',''),
WJ.WB.ARTRV=c(-0.0776,0,0,0.00325,0.0000009187,'',''),
SE.ON.ARTRW8=c(0.0384,0,0,0,0.00000191,'',''),
SE.ON.ATCO=c(0.184,0,0,-0.00173,0.0000001402,'',''),
SE.OW.ARTRW8=c(0.036,0,0,0,0.00000143,'',''),
SE.RO.ARTRW8=c(0.0386,0,0,0,0.000000787,'',''),
SW.RC.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.GB.ARTRW8=c(0.0108,0,0,0,0.00000168,'',''),
SW.RC.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.GB.CHVI8=c(0.0454,0,-0.00159,0,0.000000656,'',''),
SW.SD.ARTRW8=c(-0.0129,-0.000823,0.00249,0,0.0000002922,'',''),
SW.SD.CHVI8=c(0.0205,0,0,-0.000623,0.0000002835,'',''),
SW.MO.ARTRW8=c(0.114,0,0,0,0.0000000745,'',''),
PJ.SP.ARNO4=c(-0.154,0.00524,0,0,0,'',''),
PJ.SP.ARTRV=c(-0.013,0.00476,-0.00519,0,0.000001,'',''),
PJ.SP.CHVI8=c(0.0227,0.000769,-0.001,-0.00117,0.0000008499,'',''),
PJ.SP.PUTR2=c(0.00408,0,0,0,0.0000008327,'',''),
PJ.SR.ARTRW8=c(-0.0212,-0.00335,0.00627,0,0.0000005852,'',''),
PJ.SR.PUTR2=c(-0.42,0.00716,0,0,0.0000003605,'',''),
PJ.SV.ARAR8=c(-0.139,0.00169,0.004,0,0,'',''),
PJ.SV.ARNO4=c(0.088,0,0,-0.00293,0.0000035,'',''),
PJ.SV.ARTRW8=c(-0.03375,0,0.0009,0,0.0000008684,'',''),
PJ.SV.CHVI8=c(0.0461,-0.000828,-0.00163,0,0.00000172,'',''),
PJ.MC.ARTRW8=c(-0.133,0.00208,0.00552,0,0,'',''),
PJ.MC.ARNO4=c(0.739,0,-0.0021,0.000842,0,'',''),
PJ.MC.PUTR2=c(0.0041,0,0,0,0.0000006519,'',''),
JP.GR.ARTRW8=c(-0.0893,-0.00617,0.00764,0.00464,0.00000129,'',''),
JP.ON.ARTRW8=c(-0.23,0,0.00247,0.00796,0.00000118,'',''),
JP.ON.ARNO4=c(0.131,-0.00211,0,-0.003436,0.000000486,'',''),
JP.SC.ARTRW8=c(-0.0507,0.0029,0.00468,-0.00368,0.0000006626,'',''),
JP.ST.ARTRV=c(0.0914,0.0109,0,-0.0144,0.00000124,'',''),
JP.ST.PUTR2=c(-0.128,0,0.0144,-0.0126,0.0000006021,'','')
))

calc_sb <- function( row){
id <- row[4]
bad_id <- 0
d1 <- as.numeric( row[5])
d2 <- as.numeric( row[6])
if( !(is.na(d1) || is.na(d2)) && (d1 < d2) ){
  t <- d1
  d1 <- d2
  d2 <- t
}
h <- as.numeric( row[7])
vol <- as.numeric( row[8])
area <- as.numeric( row[9])
sb_ttl <- 0
sb_1hr <- 0
sb_10hr <- 0
body <- 'as.numeric(p[1]) + as.numeric(p[2])*d1 + as.numeric(p[3])*d2 + as.numeric(p[4])*h + as.numeric(p[5])*vol'
p <- try( p_ttl[id,], silent=TRUE)
if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
  sb_ttl <- eval( parse( text=expr))
  if( is.na( sb_ttl) || (sb_ttl < 0) ){
    sb_ttl = 0 ;
  }
  p <- try( p_1hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_1hr <- eval( parse( text=expr))
    if( is.na( sb_1hr) || (sb_1hr < 0) ){
      sb_1hr = 0 ;
    }
  }
  p <- try( p_10hr[id,], silent=TRUE)
  if( length(p) > 1 ){
  expr <- paste( sep='', '(', p[6], body, p[7], ')*10000/area')
    sb_10hr <- eval( parse( text=expr))
    if( is.na( sb_10hr) || (sb_10hr < 0) ){
      sb_10hr = 0 ;
    }
  }
}else{
  bad_id <- 1
}
return( c( bad_id, sb_ttl, sb_1hr, sb_10hr))
}

b <- ncol( vf_v94) + 1
vf_v94 <- cbind( vf_v94, t( apply( vf_v94, 1, calc_sb)))
e <- ncol( vf_v94)
names( vf_v94)[b:e] <- c( "bad_id", "shrub_bio_ttl", "shrub_1hr", "shrub_10hr")
bad_id <- c(0)
shrub_bio_ttl <- c(0)
shrub_1hr <- c(0)
shrub_10hr <- c(0)
n <- nrow( vf_v95)
i <- 1
while( i <= n ){
spid <- vf_v95[i,1]
yr <- vf_v95[i,2]
sper <- vf_v95[i,3]
vf_v96 <- subset( vf_v94, (subplot_id==spid) & (year==yr) & (speriod==sper))
bad_id[i] <- round( sum( vf_v96$bad_id), 0)
shrub_bio_ttl[i] <- round( sum( vf_v96$shrub_bio_ttl), 0)
shrub_1hr[i] <- round( sum( vf_v96$shrub_1hr), 0)
shrub_10hr[i] <- round( sum( vf_v96$shrub_10hr), 0)
if( bad_id[i] > 0 ){
  shrub_bio_ttl[i] <- -shrub_bio_ttl[i]
  shrub_1hr[i] <- -shrub_1hr[i]
  shrub_10hr[i] <- -shrub_10hr[i]
}
i <- i + 1
}
vf_v95 <- cbind( vf_v95, shrub_bio_ttl)
rm( shrub_bio_ttl)
vf_v95 <- cbind( vf_v95, shrub_1hr)
rm( shrub_1hr)
vf_v95 <- cbind( vf_v95, shrub_10hr)
rm( shrub_10hr)
res <- dbSendQuery( con, "select subplot_id, year, speriod, avg( height_cm)/100 as avg_height_m from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSV' or subplot_sample.sample_type_id='VXSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.species_txn='TEGL' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v97 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v97) == 0 ){

vf_v97 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_height_m=NA)
vf_v97 <- vf_v97[-1,]
}

vf_v95 <- merge( vf_v95, vf_v97, all=TRUE)
rm( vf_v97)

calc_sbd <- function( row){
sl1 <- as.numeric( row[5])
sl10 <- as.numeric( row[6])
shgt <- as.numeric( row[7])
return( round( (sl1 + (0.5 * sl10))/(10000*shgt), 4))
}

vf_v95 <- cbind( vf_v95, apply( vf_v95, 1, calc_sbd))
names( vf_v95)[ncol( vf_v95)] <- "shrub_bd_TEGL"
vf_v95 <- vf_v95[, -4]
vf_v95 <- vf_v95[, -4]
vf_v95 <- vf_v95[, -4]
vf_v95 <- vf_v95[, -4]
vf_v39 <- merge( vf_v39, vf_v95, all=TRUE)
rm( vf_v95)
vf_v39[is.na(vf_v39[,c(4)]),c(4)] <- 0
vf_v39[is.na(vf_v39[,c(5)]),c(5)] <- 0
vf_v39[is.na(vf_v39[,c(6)]),c(6)] <- 0
vf_v39[is.na(vf_v39[,c(7)]),c(7)] <- 0
vf_v39[is.na(vf_v39[,c(8)]),c(8)] <- 0
vf_v39[is.na(vf_v39[,c(9)]),c(9)] <- 0
vf_v39[is.na(vf_v39[,c(10)]),c(10)] <- 0
vf_v39[is.na(vf_v39[,c(11)]),c(11)] <- 0
vf_v39[is.na(vf_v39[,c(12)]),c(12)] <- 0
vf_v39[is.na(vf_v39[,c(13)]),c(13)] <- 0
vf_v39[is.na(vf_v39[,c(14)]),c(14)] <- 0
vf_v39[is.na(vf_v39[,c(15)]),c(15)] <- 0
vf_v39[is.na(vf_v39[,c(16)]),c(16)] <- 0
vf_v39[is.na(vf_v39[,c(17)]),c(17)] <- 0
vf_v39[is.na(vf_v39[,c(18)]),c(18)] <- 0

calc_ttl <- function( row){
ttl <- 0.0
ttl <- ttl + as.numeric( row[4])
ttl <- ttl + as.numeric( row[5])
ttl <- ttl + as.numeric( row[6])
ttl <- ttl + as.numeric( row[7])
ttl <- ttl + as.numeric( row[8])
ttl <- ttl + as.numeric( row[9])
ttl <- ttl + as.numeric( row[10])
ttl <- ttl + as.numeric( row[11])
ttl <- ttl + as.numeric( row[12])
ttl <- ttl + as.numeric( row[13])
ttl <- ttl + as.numeric( row[14])
ttl <- ttl + as.numeric( row[15])
ttl <- ttl + as.numeric( row[16])
ttl <- ttl + as.numeric( row[17])
ttl <- ttl + as.numeric( row[18])
return( round( ttl, 4))
}

vf_v98 <- cbind( vf_v39[, c(1,2,3)], apply( vf_v39, 1, calc_ttl))
names( vf_v98)[4] <- 'shrub_bulk_dns'
subplot <- c( subplot, list( vf_v98))
rm( vf_v98)


subplot <- c( subplot, list( vf_v39))
rm( vf_v39)


calc_live_hfl <- function( row){
gd <- as.numeric( row[6])
rslt <- round( (5.000 *  gd)  )
return( rslt)
}

calc_dead_hfl <- function( row){
dd <- as.numeric( row[8])
rslt <- round(( 5.000  * dd)) 
return( rslt)
}

calc_litter_hfl <- function( row){
tlw <- as.numeric( row[9])
lw <- as.numeric( row[10])
ld <- as.numeric( row[11])
if( is.na( tlw) || (tlw == 0) ) tlw <- lw
rslt <- round( (5.000 * tlw * ld / lw) )
if( !is.na( lw) && (lw == 0) ) rslt <- 0
return( rslt)
}

calc_stand_hfl <- function( row){
sd <- as.numeric( row[12])
rslt <- round( (5.000 *  sd)  )
return( rslt)
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, herb_ttl_wet_g, herb_growth_wet_g, herb_growth_dry_g, herb_dead_wet_g, herb_dead_dry_g, litter_ttl_wet_g, litter_samp_wet_g, litter_samp_dry_g, herb_standing_dry_g from veg_biomass inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_biomass.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v101 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v101) == 0 ){

vf_v101 <- data.frame( subplot_id=NA, year=NA, speriod=NA, herb_ttl_wet_g=NA, herb_growth_wet_g=NA, herb_growth_dry_g=NA, herb_dead_wet_g=NA, herb_dead_dry_g=NA, litter_ttl_wet_g=NA, litter_samp_wet_g=NA, litter_samp_dry_g=NA, herb_standing_dry_g=NA)
vf_v101 <- vf_v101[-1,]
}

vf_v101 <- cbind( vf_v101, apply( vf_v101, 1, calc_live_hfl))
names( vf_v101)[ncol( vf_v101)] <- "herb_fuel_live_ss"
vf_v101 <- cbind( vf_v101, apply( vf_v101, 1, calc_dead_hfl))
names( vf_v101)[ncol( vf_v101)] <- "herb_fuel_dead_ss"
vf_v101 <- cbind( vf_v101, apply( vf_v101, 1, calc_litter_hfl))
names( vf_v101)[ncol( vf_v101)] <- "ispace_litter_load_ss"
vf_v101 <- cbind( vf_v101, apply( vf_v101, 1, calc_stand_hfl))
names( vf_v101)[ncol( vf_v101)] <- "herb_fuel_stand_ss"
vf_v101 <- vf_v101[c( 1, 2, 3, 13, 14, 15, 16)]
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( height_cm) / 16 as avg_grass_ht from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKGU#' or veg_height.species_txn='UKHU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v102 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v102) == 0 ){

vf_v102 <- data.frame( subplot_id=NA, year=NA, speriod=NA, avg_grass_ht=NA)
vf_v102 <- vf_v102[-1,]
}

vf_v103 <- merge( vf_v101, vf_v102, all.x=TRUE, all.y=FALSE)
rm( vf_v101, vf_v102)

calc_hbd <- function( row){
hfl <- as.numeric( row[4]) + as.numeric( row[5])
aht <- as.numeric( row[7])
return( round( hfl/(100*aht), 4))
}

vf_v103 <- cbind( vf_v103, apply( vf_v103, 1, calc_hbd))
names( vf_v103)[ncol( vf_v103)] <- "herb_bulkdns_ss"
vf_v103 <- vf_v103[c( 1, 2, 3, 8)]
subplot <- c( subplot, list( vf_v103))
rm( vf_v103)


vf_v104 <- dbGetQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")

vf_v105 <- vf_v104
calc_td <- function( row){
hd <- as.numeric( row[4])
if( is.na( hd) ){ hd <- 0 }
hd_lt5 <- round( (10000/11.25) * hd)
sd <- as.numeric( row[5])
if( is.na( sd) ){ sd <- 0 }
sd_5_50 <- round( (10000/180) * sd)
th <- as.numeric( row[6])
if( is.na( th) ){ th <- 0 }
thb <- as.numeric( row[7])
if( is.na( thb) ){ thb <- 0 }
th_gt50 <- round( (th + thb)/0.099)
return( c( hd_lt5 + sd_5_50 + th_gt50, hd_lt5, sd_5_50, th_gt50))}
vf_v106 <- vf_v105
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='JUOS' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v107 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v107) == 0 ){

vf_v107 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v107 <- vf_v107[-1,]
}

vf_v106 <- merge( vf_v106, vf_v107, all=TRUE)
rm( vf_v107)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='JUOS' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v108 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v108) == 0 ){

vf_v108 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v108 <- vf_v108[-1,]
}

vf_v106 <- merge( vf_v106, vf_v108, all=TRUE)
rm( vf_v108)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='JUOS' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v109 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v109) == 0 ){

vf_v109 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v109 <- vf_v109[-1,]
}

vf_v106 <- merge( vf_v106, vf_v109, all=TRUE)
rm( vf_v109)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='JUOS' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v110 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v110) == 0 ){

vf_v110 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v110 <- vf_v110[-1,]
}

vf_v106 <- merge( vf_v106, vf_v110, all=TRUE)
rm( vf_v110)
vf_v106 <- apply( vf_v106, 1, calc_td)
vf_v106 <- t( vf_v106)
vf_v106 <- data.frame( vf_v106)
names( vf_v106)[1:4] <- c( "tree_dns_ttl_JUOS", "tree_dns_lt5_JUOS", "tree_dns_5_50_JUOS", "tree_dns_gt50_JUOS")
vf_v104 <- cbind( vf_v104, vf_v106)
vf_v111 <- vf_v105
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='PIED' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v112 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v112) == 0 ){

vf_v112 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v112 <- vf_v112[-1,]
}

vf_v111 <- merge( vf_v111, vf_v112, all=TRUE)
rm( vf_v112)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='PIED' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v113 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v113) == 0 ){

vf_v113 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v113 <- vf_v113[-1,]
}

vf_v111 <- merge( vf_v111, vf_v113, all=TRUE)
rm( vf_v113)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='PIED' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v114 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v114) == 0 ){

vf_v114 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v114 <- vf_v114[-1,]
}

vf_v111 <- merge( vf_v111, vf_v114, all=TRUE)
rm( vf_v114)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='PIED' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v115 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v115) == 0 ){

vf_v115 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v115 <- vf_v115[-1,]
}

vf_v111 <- merge( vf_v111, vf_v115, all=TRUE)
rm( vf_v115)
vf_v111 <- apply( vf_v111, 1, calc_td)
vf_v111 <- t( vf_v111)
vf_v111 <- data.frame( vf_v111)
names( vf_v111)[1:4] <- c( "tree_dns_ttl_PIED", "tree_dns_lt5_PIED", "tree_dns_5_50_PIED", "tree_dns_gt50_PIED")
vf_v104 <- cbind( vf_v104, vf_v111)
vf_v116 <- vf_v105
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='PIMO' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v117 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v117) == 0 ){

vf_v117 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v117 <- vf_v117[-1,]
}

vf_v116 <- merge( vf_v116, vf_v117, all=TRUE)
rm( vf_v117)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='PIMO' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v118 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v118) == 0 ){

vf_v118 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v118 <- vf_v118[-1,]
}

vf_v116 <- merge( vf_v116, vf_v118, all=TRUE)
rm( vf_v118)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='PIMO' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v119 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v119) == 0 ){

vf_v119 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v119 <- vf_v119[-1,]
}

vf_v116 <- merge( vf_v116, vf_v119, all=TRUE)
rm( vf_v119)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='PIMO' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v120 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v120) == 0 ){

vf_v120 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v120 <- vf_v120[-1,]
}

vf_v116 <- merge( vf_v116, vf_v120, all=TRUE)
rm( vf_v120)
vf_v116 <- apply( vf_v116, 1, calc_td)
vf_v116 <- t( vf_v116)
vf_v116 <- data.frame( vf_v116)
names( vf_v116)[1:4] <- c( "tree_dns_ttl_PIMO", "tree_dns_lt5_PIMO", "tree_dns_5_50_PIMO", "tree_dns_gt50_PIMO")
vf_v104 <- cbind( vf_v104, vf_v116)
vf_v121 <- vf_v105
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as hd_cnt from veg_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_count.species_type='A' ) and ( veg_count.species_txn='JUOC' )) and veg_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v122 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v122) == 0 ){

vf_v122 <- data.frame( subplot_id=NA, year=NA, speriod=NA, hd_cnt=NA)
vf_v122 <- vf_v122[-1,]
}

vf_v121 <- merge( vf_v121, vf_v122, all=TRUE)
rm( vf_v122)
res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( count_cnt) as sd_cnt from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.species_type='A' ) and ( veg_density_count.species_txn='JUOC' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v123 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v123) == 0 ){

vf_v123 <- data.frame( subplot_id=NA, year=NA, speriod=NA, sd_cnt=NA)
vf_v123 <- vf_v123[-1,]
}

vf_v121 <- merge( vf_v121, vf_v123, all=TRUE)
rm( vf_v123)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as th_cnt from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn='P' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_type='A' ) and ( veg_tree_stature.species_txn='JUOC' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v124 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v124) == 0 ){

vf_v124 <- data.frame( subplot_id=NA, year=NA, speriod=NA, th_cnt=NA)
vf_v124 <- vf_v124[-1,]
}

vf_v121 <- merge( vf_v121, vf_v124, all=TRUE)
rm( vf_v124)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as thb_cnt from veg_tree_ht_burned inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHD' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTB' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_ht_burned.species_type='A' ) and ( veg_tree_ht_burned.species_txn='JUOC' )) and veg_tree_ht_burned.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v125 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v125) == 0 ){

vf_v125 <- data.frame( subplot_id=NA, year=NA, speriod=NA, thb_cnt=NA)
vf_v125 <- vf_v125[-1,]
}

vf_v121 <- merge( vf_v121, vf_v125, all=TRUE)
rm( vf_v125)
vf_v121 <- apply( vf_v121, 1, calc_td)
vf_v121 <- t( vf_v121)
vf_v121 <- data.frame( vf_v121)
names( vf_v121)[1:4] <- c( "tree_dns_ttl_JUOC", "tree_dns_lt5_JUOC", "tree_dns_5_50_JUOC", "tree_dns_gt50_JUOC")
vf_v104 <- cbind( vf_v104, vf_v121)
subplot <- c( subplot, list( vf_v104))
rm( vf_v104)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSSD') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v126 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v126) == 0 ){

vf_v126 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v126 <- vf_v126[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ARTRW8 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ARTRW8' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v127 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v127) == 0 ){

vf_v127 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ARTRW8=NA)
vf_v127 <- vf_v127[-1,]
}

vf_v126 <- merge( vf_v126, vf_v127, all=TRUE)
rm( vf_v127)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ATCO from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ATCO' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v128 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v128) == 0 ){

vf_v128 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ATCO=NA)
vf_v128 <- vf_v128[-1,]
}

vf_v126 <- merge( vf_v126, vf_v128, all=TRUE)
rm( vf_v128)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_CHVI8 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='CHVI8' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v129 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v129) == 0 ){

vf_v129 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_CHVI8=NA)
vf_v129 <- vf_v129[-1,]
}

vf_v126 <- merge( vf_v126, vf_v129, all=TRUE)
rm( vf_v129)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_EPVI from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='EPVI' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v130 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v130) == 0 ){

vf_v130 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_EPVI=NA)
vf_v130 <- vf_v130[-1,]
}

vf_v126 <- merge( vf_v126, vf_v130, all=TRUE)
rm( vf_v130)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ERNA10 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ERNA10' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v131 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v131) == 0 ){

vf_v131 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ERNA10=NA)
vf_v131 <- vf_v131[-1,]
}

vf_v126 <- merge( vf_v126, vf_v131, all=TRUE)
rm( vf_v131)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_ERSP7 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='ERSP7' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v132 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v132) == 0 ){

vf_v132 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_ERSP7=NA)
vf_v132 <- vf_v132[-1,]
}

vf_v126 <- merge( vf_v126, vf_v132, all=TRUE)
rm( vf_v132)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_GUSA2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='GUSA2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v133 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v133) == 0 ){

vf_v133 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_GUSA2=NA)
vf_v133 <- vf_v133[-1,]
}

vf_v126 <- merge( vf_v126, vf_v133, all=TRUE)
rm( vf_v133)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_PUST from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='PUST' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v134 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v134) == 0 ){

vf_v134 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_PUST=NA)
vf_v134 <- vf_v134[-1,]
}

vf_v126 <- merge( vf_v126, vf_v134, all=TRUE)
rm( vf_v134)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_PUTR2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='PUTR2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v135 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v135) == 0 ){

vf_v135 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_PUTR2=NA)
vf_v135 <- vf_v135[-1,]
}

vf_v126 <- merge( vf_v126, vf_v135, all=TRUE)
rm( vf_v135)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( sum( count_cnt) * 1000 / (180 * 0.099)) as shrub_dns_TECA2 from veg_density_count inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_density_count.type_sdt='DS5' or veg_density_count.type_sdt='DS15' or veg_density_count.type_sdt='ODS5' ) and ( veg_density_count.species_txn='TECA2' )) and veg_density_count.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v136 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v136) == 0 ){

vf_v136 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_dns_TECA2=NA)
vf_v136 <- vf_v136[-1,]
}

vf_v126 <- merge( vf_v126, vf_v136, all=TRUE)
rm( vf_v136)
vf_v126[is.na(vf_v126[,c( ncol( vf_v126))]),c( ncol( vf_v126))] <- 0
subplot <- c( subplot, list( vf_v126))
rm( vf_v126)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v137 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v137) == 0 ){

vf_v137 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v137 <- vf_v137[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ARAR8 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ARAR8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v138 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v138) == 0 ){

vf_v138 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ARAR8=NA)
vf_v138 <- vf_v138[-1,]
}

vf_v137 <- merge( vf_v137, vf_v138, all=TRUE)
rm( vf_v138)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ARNO4 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ARNO4' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v139 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v139) == 0 ){

vf_v139 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ARNO4=NA)
vf_v139 <- vf_v139[-1,]
}

vf_v137 <- merge( vf_v137, vf_v139, all=TRUE)
rm( vf_v139)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ARTRW8 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ARTRW8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v140 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v140) == 0 ){

vf_v140 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ARTRW8=NA)
vf_v140 <- vf_v140[-1,]
}

vf_v137 <- merge( vf_v137, vf_v140, all=TRUE)
rm( vf_v140)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ATCO from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ATCO' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v141 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v141) == 0 ){

vf_v141 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ATCO=NA)
vf_v141 <- vf_v141[-1,]
}

vf_v137 <- merge( vf_v137, vf_v141, all=TRUE)
rm( vf_v141)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_CHVI8 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='CHVI8' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v142 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v142) == 0 ){

vf_v142 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_CHVI8=NA)
vf_v142 <- vf_v142[-1,]
}

vf_v137 <- merge( vf_v137, vf_v142, all=TRUE)
rm( vf_v142)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_EPNE from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='EPNE' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v143 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v143) == 0 ){

vf_v143 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_EPNE=NA)
vf_v143 <- vf_v143[-1,]
}

vf_v137 <- merge( vf_v137, vf_v143, all=TRUE)
rm( vf_v143)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_EPVI from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='EPVI' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v144 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v144) == 0 ){

vf_v144 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_EPVI=NA)
vf_v144 <- vf_v144[-1,]
}

vf_v137 <- merge( vf_v137, vf_v144, all=TRUE)
rm( vf_v144)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ERNA10 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ERNA10' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v145 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v145) == 0 ){

vf_v145 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ERNA10=NA)
vf_v145 <- vf_v145[-1,]
}

vf_v137 <- merge( vf_v137, vf_v145, all=TRUE)
rm( vf_v145)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_ERSP7 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='ERSP7' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v146 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v146) == 0 ){

vf_v146 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_ERSP7=NA)
vf_v146 <- vf_v146[-1,]
}

vf_v137 <- merge( vf_v137, vf_v146, all=TRUE)
rm( vf_v146)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_GRSP from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='GRSP' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v147 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v147) == 0 ){

vf_v147 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_GRSP=NA)
vf_v147 <- vf_v147[-1,]
}

vf_v137 <- merge( vf_v137, vf_v147, all=TRUE)
rm( vf_v147)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_GUSA2 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='GUSA2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v148 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v148) == 0 ){

vf_v148 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_GUSA2=NA)
vf_v148 <- vf_v148[-1,]
}

vf_v137 <- merge( vf_v137, vf_v148, all=TRUE)
rm( vf_v148)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_PUST from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='PUST' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v149 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v149) == 0 ){

vf_v149 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_PUST=NA)
vf_v149 <- vf_v149[-1,]
}

vf_v137 <- merge( vf_v137, vf_v149, all=TRUE)
rm( vf_v149)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_PUTR2 from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='PUTR2' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v150 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v150) == 0 ){

vf_v150 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_PUTR2=NA)
vf_v150 <- vf_v150[-1,]
}

vf_v137 <- merge( vf_v137, vf_v150, all=TRUE)
rm( vf_v150)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as shrub_ht_avg_TEGL from veg_volume inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' or subplot_sample.sample_type_id='VSSV' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_volume.height_cm>'15' ) and ( veg_volume.species_type='B' ) and ( veg_volume.species_txn='TEGL' )) and veg_volume.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v151 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v151) == 0 ){

vf_v151 <- data.frame( subplot_id=NA, year=NA, speriod=NA, shrub_ht_avg_TEGL=NA)
vf_v151 <- vf_v151[-1,]
}

vf_v137 <- merge( vf_v137, vf_v151, all=TRUE)
rm( vf_v151)
vf_v137[is.na(vf_v137[,c( ncol( vf_v137))]),c( ncol( vf_v137))] <- 0
subplot <- c( subplot, list( vf_v137))
rm( vf_v137)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v152 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v152) == 0 ){

vf_v152 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v152 <- vf_v152[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as grass_ht_avg from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKGU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v153 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v153) == 0 ){

vf_v153 <- data.frame( subplot_id=NA, year=NA, speriod=NA, grass_ht_avg=NA)
vf_v153 <- vf_v153[-1,]
}

vf_v152 <- merge( vf_v152, vf_v153, all=TRUE)
rm( vf_v153)
vf_v152[is.na(vf_v152[,c( ncol( vf_v152))]),c( ncol( vf_v152))] <- 0
res <- dbSendQuery( con, "select subplot_id, year, speriod, round( (sum( height_cm) / count( height_cm)), 1) as forb_ht_avg from veg_height inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSHF' or subplot_sample.sample_type_id='VXSV' or subplot_sample.sample_type_id='VXVH' or subplot_sample.sample_type_id='VSSD' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_height.species_txn='UKHU#' )) and veg_height.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v154 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v154) == 0 ){

vf_v154 <- data.frame( subplot_id=NA, year=NA, speriod=NA, forb_ht_avg=NA)
vf_v154 <- vf_v154[-1,]
}

vf_v152 <- merge( vf_v152, vf_v154, all=TRUE)
rm( vf_v154)
vf_v152[is.na(vf_v152[,c( ncol( vf_v152))]),c( ncol( vf_v152))] <- 0
subplot <- c( subplot, list( vf_v152))
rm( vf_v152)


res <- dbSendQuery( con, "select subplot_id, year, speriod, species, count( species) as counts from (select subplot_id, year, speriod, species from ((select subplot_id, year, speriod, transect_tct, point_tpt, species_foc as species from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_foliar.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, species_cnp as species from veg_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_canopy.dead_yn='N' or veg_canopy.dead_yn is null )) and veg_canopy.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, ground_surface_gsc as species from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id )) as composite group by subplot_id, year, speriod, transect_tct, point_tpt, species) as tables_merged group by subplot_id, year, speriod, species order by subplot_id, year, speriod, species")
vf_v155 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v155) == 0 ){

vf_v155 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v155 <- vf_v155[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v156 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v156) == 0 ){

vf_v156 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v156 <- vf_v156[-1,]
}

vf_v155 <- merge( vf_v155, vf_v156, all.x=TRUE, all.y=FALSE)
calc_cover <- function( row){
sp_cnt <- as.numeric( row[5])
if( is.na( sp_cnt) ){ sp_cnt <- 0 }
trans_cnt <- as.numeric( row[6])
if( is.na( trans_cnt) || (trans_cnt == 0) ){ return( NA) }
return( as.numeric( sp_cnt) * 100/(60 * trans_cnt))
}

cover <- apply( vf_v155, 1, calc_cover)
cover <- round( cover, 1)
vf_v155 <- cbind( vf_v155, cover)
if( nrow( vf_v155) > 0 ){
vf_v155 <- vf_v155[,!(colnames( vf_v155) %in% c( "counts"))]
}
if( nrow( vf_v155) > 0 ){
vf_v155 <- vf_v155[,!(colnames( vf_v155) %in% c( "transect_count"))]
}
vf_v158 <- vf_v155[,1:3]
vf_v158 <- unique( vf_v158)
vf_v157 <- vf_v158
i <- 3
factors <- unique( sort( vf_v155$species))
for( f in factors ){
i <- i + 1
vf_v159 <- subset( vf_v155, species==f, c( subplot_id, year, speriod, cover))
vf_v159 <- merge( vf_v158, vf_v159, all=TRUE)
vf_v159[,4] <- ifelse( is.na( vf_v159[,4]), 0, vf_v159[,4])
vf_v159 <- vf_v159[,4]
vf_v157 <- cbind( vf_v157, vf_v159)
n <- f
names( vf_v157)[i] = paste( sep='', 'can_cover_', n)
rm( vf_v159)
}
subplot <- c( subplot, list( vf_v157))
rm( vf_v157)


vf_v160 <- dbGetQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")

vf_v161 <- vf_v160
calc_crn_cvr <- function( row){
dxd <- as.numeric( row[4])
if( is.na( dxd) ){ dxd <- 0 }
return( round( (pi/4) * dxd / 990, 1))}
tree_cover_ttl <- rep( 0, nrow( vf_v160))
vf_v160 <- cbind( vf_v160, tree_cover_ttl)
vf_v162 <- vf_v161
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='JUOS' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='JUOS' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v163 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v163) == 0 ){

vf_v163 <- c( 0)
}

vf_v162 <- merge( vf_v162, vf_v163, all=TRUE)
vf_v162 <- apply( vf_v162, 1, calc_crn_cvr)
vf_v162 <- data.frame( vf_v162)
names( vf_v162)[1] <- "tree_cvr_JUOS"
vf_v160 <- cbind( vf_v160, vf_v162)
vf_v164 <- vf_v161
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='PIED' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='PIED' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v165 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v165) == 0 ){

vf_v165 <- c( 0)
}

vf_v164 <- merge( vf_v164, vf_v165, all=TRUE)
vf_v164 <- apply( vf_v164, 1, calc_crn_cvr)
vf_v164 <- data.frame( vf_v164)
names( vf_v164)[1] <- "tree_cvr_PIED"
vf_v160 <- cbind( vf_v160, vf_v164)
vf_v166 <- vf_v161
res <- dbSendQuery( con, "(select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null ) and ( veg_tree_stature.species_txn='PIMO' )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) union (select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_canopy inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTH' or subplot_sample.sample_type_id='VSTC' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_canopy.species_txn='PIMO' )) and veg_tree_canopy.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod) ")
vf_v167 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v167) == 0 ){

vf_v167 <- c( 0)
}

vf_v166 <- merge( vf_v166, vf_v167, all=TRUE)
vf_v166 <- apply( vf_v166, 1, calc_crn_cvr)
vf_v166 <- data.frame( vf_v166)
names( vf_v166)[1] <- "tree_cvr_PIMO"
vf_v160 <- cbind( vf_v160, vf_v166)
vf_v160[4] <- vf_v160[4] + vf_v160[5]
vf_v160[4] <- vf_v160[4] + vf_v160[6]
vf_v160[4] <- vf_v160[4] + vf_v160[7]
subplot <- c( subplot, list( vf_v160))
rm( vf_v160)


res <- dbSendQuery( con, "select subplot_id, year, speriod, pl_type, count( pl_type) as counts from (select subplot_id, year, speriod, pl_type from ((select subplot_id, year, speriod, transect_tct, point_tpt, species_type as pl_type from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_foliar.subplot_sample_id=sids.subplot_sample_id ) union (select subplot_id, year, speriod, transect_tct, point_tpt, species_type as pl_type from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id )) as composite group by subplot_id, year, speriod, transect_tct, point_tpt, pl_type) as tables_merged group by subplot_id, year, speriod, pl_type order by subplot_id, year, speriod, pl_type")
vf_v168 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v168) == 0 ){

vf_v168 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v168 <- vf_v168[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v169 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v169) == 0 ){

vf_v169 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v169 <- vf_v169[-1,]
}

vf_v168 <- merge( vf_v168, vf_v169, all.x=TRUE, all.y=FALSE)
calc_cover <- function( row){
sp_cnt <- as.numeric( row[5])
if( is.na( sp_cnt) ){ sp_cnt <- 0 }
trans_cnt <- as.numeric( row[6])
if( is.na( trans_cnt) || (trans_cnt == 0) ){ return( NA) }
return( as.numeric( sp_cnt) * 100/(60 * trans_cnt))
}

cover <- apply( vf_v168, 1, calc_cover)
cover <- round( cover, 1)
vf_v168 <- cbind( vf_v168, cover)
if( nrow( vf_v168) > 0 ){
vf_v168 <- vf_v168[,!(colnames( vf_v168) %in% c( "counts"))]
}
if( nrow( vf_v168) > 0 ){
vf_v168 <- vf_v168[,!(colnames( vf_v168) %in% c( "transect_count"))]
}
vf_v171 <- vf_v168[,1:3]
vf_v171 <- unique( vf_v171)
vf_v170 <- vf_v171
i <- 3
factors <- unique( sort( vf_v168$pl_type))
for( f in factors ){
i <- i + 1
vf_v172 <- subset( vf_v168, pl_type==f, c( subplot_id, year, speriod, cover))
vf_v172 <- merge( vf_v171, vf_v172, all=TRUE)
vf_v172[,4] <- ifelse( is.na( vf_v172[,4]), 0, vf_v172[,4])
vf_v172 <- vf_v172[,4]
vf_v170 <- cbind( vf_v170, vf_v172)
n <- f
if( f == 'A' ){ n <- 'tree' }
if( f == 'B' ){ n <- 'shrub' }
if( f == 'C' ){ n <- 'pgrass' }
if( f == 'D' ){ n <- 'pforb' }
if( f == 'E' ){ n <- 'agrass' }
if( f == 'F' ){ n <- 'aforb' }
if( f == 'G' ){ n <- 'grass' }
if( f == 'H' ){ n <- 'forb' }
names( vf_v170)[i] = paste( sep='', 'fol_cover_pt_', n)
rm( vf_v172)
}
subplot <- c( subplot, list( vf_v170))
rm( vf_v170)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v173 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v173) == 0 ){

vf_v173 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v173 <- vf_v173[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as counts from (select * from (select subplot_id, year, speriod, transect_tct, point_tpt from veg_foliar inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_foliar.species_foc='L' or veg_foliar.species_foc='W' )) and veg_foliar.subplot_sample_id=sids.subplot_sample_id  union select subplot_id, year, speriod, transect_tct, point_tpt from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_surface.ground_surface_gsc='EL' or veg_surface.ground_surface_gsc='D' )) and veg_surface.subplot_sample_id=sids.subplot_sample_id ) as hits group by subplot_id, year, speriod, transect_tct, point_tpt order by subplot_id, year, speriod) as counts group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v174 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v174) == 0 ){

vf_v174 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v174 <- vf_v174[-1,]
}

vf_v174 <- merge( vf_v173, vf_v174, all=TRUE)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v175 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v175) == 0 ){

vf_v175 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v175 <- vf_v175[-1,]
}

vf_v174 <- merge( vf_v174, vf_v175, all.x=TRUE, all.y=FALSE)

get_sc <- function( row){
cnt <- row[4]
if( is.na( cnt) ) cnt <- 0
return( round( as.numeric( cnt) * 100/(60 * as.numeric( row[5])), 1))
}

vf_v174 <- cbind( vf_v174, apply( vf_v174, 1, get_sc))
names( vf_v174)[ncol( vf_v174)] <- "litter_cover"
if( nrow( vf_v174) > 0 ){
vf_v174 <- vf_v174[,!(colnames( vf_v174) %in% c( "counts"))]
}
if( nrow( vf_v174) > 0 ){
vf_v174 <- vf_v174[,!(colnames( vf_v174) %in% c( "transect_count"))]
}
subplot <- c( subplot, list( vf_v174))
rm( vf_v174)


res <- dbSendQuery( con, "(select subplot_sample.subplot_id, subplot_sample.year, subplot_sample.sample_period as speriod from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' )) and (subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP') and subplot_sample.subplot_id=subplots.id group by subplot_id, year, speriod order by subplot_id, year, speriod) ")
vf_v176 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v176) == 0 ){

vf_v176 <- data.frame( subplot_id=NA, year=NA, speriod=NA)
vf_v176 <- vf_v176[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, count(*) as counts from (select * from (select subplot_id, year, speriod, transect_tct, point_tpt from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_surface.ground_surface_gsc='R' or veg_surface.ground_surface_gsc='BR' or veg_surface.ground_surface_gsc='S' )) and veg_surface.subplot_sample_id=sids.subplot_sample_id ) as hits group by subplot_id, year, speriod, transect_tct, point_tpt order by subplot_id, year, speriod) as counts group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v177 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v177) == 0 ){

vf_v177 <- data.frame( subplot_id=NA, year=NA, speriod=NA, counts=NA)
vf_v177 <- vf_v177[-1,]
}

vf_v177 <- merge( vf_v176, vf_v177, all=TRUE)
res <- dbSendQuery( con, "select subplot_id, year, speriod, count( transect) as transect_count from (select subplot_id, year, speriod, transect from ((select subplot_id, year, speriod, transect_tct as transect from veg_surface inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSLP' or subplot_sample.sample_type_id='VXLP' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_surface.subplot_sample_id=sids.subplot_sample_id group by subplot_id, year, speriod, transect)) as composite group by subplot_id, year, speriod, transect) as tables_merged group by subplot_id, year, speriod order by subplot_id, year, speriod")
vf_v178 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v178) == 0 ){

vf_v178 <- data.frame( subplot_id=NA, year=NA, speriod=NA, transect_count=NA)
vf_v178 <- vf_v178[-1,]
}

vf_v177 <- merge( vf_v177, vf_v178, all.x=TRUE, all.y=FALSE)

get_sc <- function( row){
cnt <- row[4]
if( is.na( cnt) ) cnt <- 0
return( round( as.numeric( cnt) * 100/(60 * as.numeric( row[5])), 1))
}

vf_v177 <- cbind( vf_v177, apply( vf_v177, 1, get_sc))
names( vf_v177)[ncol( vf_v177)] <- "bare_gnd_cover"
if( nrow( vf_v177) > 0 ){
vf_v177 <- vf_v177[,!(colnames( vf_v177) %in% c( "counts"))]
}
if( nrow( vf_v177) > 0 ){
vf_v177 <- vf_v177[,!(colnames( vf_v177) %in% c( "transect_count"))]
}
subplot <- c( subplot, list( vf_v177))
rm( vf_v177)


res <- dbSendQuery( con, "select subplot_id, year, speriod, live_tree_dry_g, dead_tree_dry_g, live_tree_count, dead_tree_count from veg_ld_moisture_cs inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.year='16' or subplot_sample.year='17' ) and ( subplot_sample.sample_type_id='VSTL' )) and subplot_sample.subplot_id=subplots.id) as sids on veg_ld_moisture_cs.subplot_sample_id=sids.subplot_sample_id order by subplot_id, year, speriod ")
vf_v179 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v179) == 0 ){

vf_v179 <- data.frame( subplot_id=NA, year=NA, speriod=NA, live_tree_dry_g=NA, dead_tree_dry_g=NA, live_tree_count=NA, dead_tree_count=NA)
vf_v179 <- vf_v179[-1,]
}

res <- dbSendQuery( con, "select subplot_id, year, speriod, sum( crown_dia_longest_dm * crown_dia_perp_dm) as dxd from veg_tree_stature inner join (select subplot_sample.subplot_id, year, sample_period as speriod, subplot_sample.id as subplot_sample_id from subplot_sample, (select subplot.id from subplot, (select plot.id from plot, (select site.id from site, (select region.id from region where (( region.code='JP' ))  order by region.id) as regions  where (( site.code='ON' or site.code='SC' or site.code='GR' )) and site.region_id=regions.id order by site.id) as sites  where (( plot.type='CP' )) and plot.site_id=sites.id order by plot.id) as plots  where (( subplot.treatment='CO' or subplot.treatment='FI' or subplot.treatment='ME' or subplot.treatment='BM' )) and subplot.plot_id=plots.id order by subplot.id) as subplots  where (( subplot_sample.post_treatment_yn='N' or subplot_sample.post_treatment_yn='Y' ) and ( subplot_sample.sample_type_id='VSTH' )) and subplot_sample.subplot_id=subplots.id) as sids on (( veg_tree_stature.dead_yn='N' or veg_tree_stature.dead_yn is null )) and veg_tree_stature.subplot_sample_id=sids.subplot_sample_id  group by subplot_id, year, speriod order by subplot_id, year, speriod ")
vf_v180 <- fetch( res, n=-1)
dbClearResult( res)

if( nrow( vf_v180) == 0 ){

vf_v180 <- data.frame( subplot_id=NA, year=NA, speriod=NA, dxd=NA)
vf_v180 <- vf_v180[-1,]
}

vf_v181 <- merge( vf_v179, vf_v180, all.x=TRUE, all.y=FALSE)
rm( vf_v179, vf_v180)

calc_tcover <- function( row){
tcover <- (pi/4) * as.numeric( row[8]) / 99000
return( tcover)
}

vf_v181 <- cbind( vf_v181, apply( vf_v181, 1, calc_tcover))
names( vf_v181)[ncol( vf_v181)] <- "tcover"

calc_ltlitterduff <- function( row){
A <- as.numeric( row[9])
ltdg <- as.numeric( row[4])
n <- as.numeric( row[6])
return( round( (ltdg *  A * (160 / n)), 0))
}

vf_v181 <- cbind( vf_v181, apply( vf_v181, 1, calc_ltlitterduff))
names( vf_v181)[ncol( vf_v181)] <- "live_tree_ltr_duff_ld"

calc_dtlitterduff <- function( row){
A <- as.numeric( row[9])
dtdg <- as.numeric( row[5])
n <- as.numeric( row[7])
return( round( (dtdg *  A * (160 / n)), 0))
}

vf_v181 <- cbind( vf_v181, apply( vf_v181, 1, calc_dtlitterduff))
names( vf_v181)[ncol( vf_v181)] <- "dead_tree_ltr_duff_ld"

calc_ttltlitterduff <- function( row){
ltld <- as.numeric( row[10])
if( is.na( ltld)) ltld <- 0 
dtld <- as.numeric( row[11])
if( is.na( dtld)) dtld <- 0 
return( ltld + dtld)
}

vf_v181 <- cbind( vf_v181, apply( vf_v181, 1, calc_ttltlitterduff))
names( vf_v181)[ncol( vf_v181)] <- "tree_ltr_duff_ld"
vf_v181 <- vf_v181[c( 1, 2, 3, 10, 11, 12)]
subplot <- c( subplot, list( vf_v181))
rm( vf_v181)


if( length( set) > 0 ){
  for( df in set ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( set)
}
if( length( subplot) > 0 ){
  for( df in subplot ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( subplot)
}
if( nrow( out) > 0 ){
      out <- merge( out, base, all.x=TRUE, all.y=FALSE)
}
rm( base)

if( length( attr) > 0 ){
  for( df in attr ){
    if( nrow( out) == 0 ){
      out <- df
    } else {
      out <- merge( out, df, all=TRUE)
    }
  }
  rm( attr)
}
if( exists( "only") ){
      out <- only
}



write.csv( out, "/home3/s/sagestep/public_html/temp/data20180416145246.csv", row.names=FALSE,  na="NA")
q()
